---
import type { Language } from "../lib/i18n";
import { getTranslations } from "../lib/i18n";
import "../styles/global.css";
import SEOHead from "../components/seo/SEOHead.astro";
import Header from "../components/navigation/Header.astro";
import { ChevronUp } from "lucide-astro";

interface Props {
  title?: string;
  description?: string;
  lang: Language;
  currentChapter?: number;
  ogImage?: string;
  hideHeader?: boolean;
  hideFooter?: boolean;
}

const {
  title,
  description,
  lang = "ne",
  currentChapter,
  ogImage,
  hideHeader = false,
  hideFooter = false,
} = Astro.props;

const t = getTranslations(lang);
const pageTitle = title ? `${title} | ${t.meta.siteName}` : t.meta.title;
const pageDescription = description || t.meta.description;
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <meta
      name="google-site-verification"
      content="google38d4d8fd76de146c.html"
    />

    <SEOHead
      title={pageTitle}
      description={pageDescription}
      lang={lang}
      ogImage={ogImage}
      currentPath={Astro.url.pathname}
    />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Preload Critical Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Serif:wght@300;400;500;600;700&family=Noto+Serif+Devanagari:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
  </head>
  <body lang={lang}>
    {!hideHeader && <Header lang={lang} currentChapter={currentChapter} />}

    <main id="main-content">
      <slot />
    </main>

    {
      !hideFooter && (
        <footer class="bg-slate-950 text-white py-8 mt-16 no-print">
          <div class="container">
            <div class="text-center">
              <p class="mb-2">{t.footer.copyright}</p>
              <div class="flex justify-center gap-4 text-sm">
                <a
                  href={`/${lang}/contact`}
                  class="hover:text-primary-400 transition-colors"
                >
                  {t.footer.contact}
                </a>
                <span>â€¢</span>
                <a
                  href={`/${lang}/privacy`}
                  class="hover:text-primary-400 transition-colors"
                >
                  {t.footer.privacy}
                </a>
              </div>
            </div>
          </div>
        </footer>
      )
    }

    <!-- Back to Top Button -->
    <button
      id="back-to-top"
      class="fixed bottom-10 right-10 z-50 flex items-center justify-center w-14 h-14 rounded-full bg-slate-900/40 backdrop-blur-xl border border-white/10 text-white shadow-2xl opacity-0 translate-y-10 pointer-events-none transition-all duration-700 cubic-bezier(0.2, 0.8, 0.2, 1) hover:bg-white hover:text-slate-950 hover:scale-110 group no-print"
      aria-label={t.labels.backToTop}
    >
      <div class="relative flex flex-col items-center">
        <ChevronUp
          size={28}
          class="transition-transform duration-500 group-hover:-translate-y-1"
        />
        <div
          class="absolute -bottom-1 w-1 h-1 bg-current rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500"
        >
        </div>
      </div>
    </button>

    <script>
      const backToTopButton = document.getElementById("back-to-top");

      const handleScroll = () => {
        if (window.scrollY > 400) {
          backToTopButton?.classList.remove(
            "opacity-0",
            "translate-y-10",
            "pointer-events-none",
          );
          backToTopButton?.classList.add("opacity-100", "translate-y-0");
        } else {
          backToTopButton?.classList.add(
            "opacity-0",
            "translate-y-10",
            "pointer-events-none",
          );
          backToTopButton?.classList.remove("opacity-100", "translate-y-0");
        }
      };

      // Throttled scroll listener
      let isScrolling = false;
      window.addEventListener("scroll", () => {
        if (!isScrolling) {
          window.requestAnimationFrame(() => {
            handleScroll();
            isScrolling = false;
          });
          isScrolling = true;
        }
      });

      backToTopButton?.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    </script>
  </body>
</html>
