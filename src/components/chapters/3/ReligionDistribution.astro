---
import type { Language } from "../../../lib/i18n";
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

const formatNumber = (val: string | number, decimals = 0) => {
    const nepaliToEnglish = (str: string) =>
        str.replace(
            /[०१२३४५६७८९]/g,
            (d) => "0123456789"["०१२३४५६७८९".indexOf(d)],
        );

    let num: number;
    if (typeof val === "string") {
        const cleaned = val.replace(/,/g, "");
        num = parseFloat(nepaliToEnglish(cleaned));
    } else {
        num = val;
    }

    if (isNaN(num)) return val.toString();

    const formatted = num.toLocaleString("en-US", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals,
    });

    if (lang !== "ne") return formatted;

    const nepaliDigits = ["०", "१", "२", "३", "४", "५", "६", "७", "८", "९"];
    return formatted.replace(/\d/g, (digit) => nepaliDigits[parseInt(digit)]);
};

type ReligionContent = {
    title: string;
    number: string;
    content_1: string;
    content_2: string;
    table_title: string;
    table_number: string;
    source: string;
    table_data: Array<{
        gender: string;
        hindu: string;
        buddhist: string;
        islam: string;
        kirat: string;
        christian: string;
        prakriti: string;
        total: string;
    }>;
    content_final: string;
};

const content = await loadChapterSection<ReligionContent>(3, "religion", lang);

if (!content) {
    throw new Error("Religion section content not found");
}
---

<section
    id="religion"
    class="relative bg-[#050505] pb-8 md:pb-12 border-t border-[#f2e25d]/10 pt-8 mt-8"
>
    <div class="container mx-auto px-8">
        <div class="w-full">
            <!-- 3.5 Header -->
            <div class="mb-8">
                <h3
                    class="font-serif text-2xl md:text-3xl font-medium text-zinc-100 mb-6"
                >
                    {content.number}
                    {content.title}
                </h3>
            </div>

            <p
                class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-6 text-justify"
            >
                {content.content_1}
            </p>

            <p
                class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-10 text-justify"
            >
                {content.content_2}
            </p>

            <!-- Table -->
            <div class="mb-10 w-full overflow-hidden">
                <h4
                    class="font-serif text-xl md:text-2xl text-zinc-100 font-medium mb-4 text-center"
                >
                    {content.table_number}: {content.table_title}
                </h4>
                <div class="overflow-x-auto">
                    <table
                        class="w-full border-collapse bg-[#0a0a0a] border border-[#f2e25d]/10 text-sm md:text-lg text-center"
                    >
                        <thead>
                            <tr
                                class="bg-[#f2e25d]/5 border-b border-[#f2e25d]/20 text-zinc-100"
                            >
                                <th
                                    class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                >
                                    {lang === "ne" ? "लिङ्ग" : "Gender"}
                                </th>
                                <th
                                    class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                >
                                    {lang === "ne" ? "हिन्दू" : "Hindu"}
                                </th>
                                <th
                                    class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                >
                                    {
                                        lang === "ne"
                                            ? "बौद्ध मार्गी"
                                            : "Buddhist"
                                    }
                                </th>
                                <th
                                    class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                >
                                    {lang === "ne" ? "इस्लाम" : "Islam"}
                                </th>
                                <th
                                    class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                >
                                    {lang === "ne" ? "किराँत" : "Kirat"}
                                </th>
                                <th
                                    class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                >
                                    {lang === "ne" ? "क्रिश्चियन" : "Christian"}
                                </th>
                                <th
                                    class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                >
                                    {lang === "ne" ? "प्रकृति" : "Prakriti"}
                                </th>
                                <th class="px-4 py-3 font-serif font-medium">
                                    {lang === "ne" ? "जम्मा" : "Total"}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {
                                content.table_data.map((row) => {
                                    const isTotal =
                                        row.gender === "जम्मा" ||
                                        row.gender === "Total";
                                    const isPercentage =
                                        row.gender === "प्रतिशत" ||
                                        row.gender === "Percentage";
                                    return (
                                        <tr
                                            class={`border-b border-[#f2e25d]/5 hover:bg-[#f2e25d]/5 transition-colors duration-200 text-zinc-100 font-serif ${isTotal || isPercentage ? "bg-[#f2e25d]/10 font-bold border-t-2 border-[#f2e25d]/30" : ""}`}
                                        >
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5 font-medium">
                                                {row.gender}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.hindu,
                                                    isPercentage ? 2 : 0,
                                                )}
                                                {isPercentage ? "%" : ""}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.buddhist,
                                                    isPercentage ? 2 : 0,
                                                )}
                                                {isPercentage ? "%" : ""}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.islam,
                                                    isPercentage ? 2 : 0,
                                                )}
                                                {isPercentage ? "%" : ""}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.kirat,
                                                    isPercentage ? 2 : 0,
                                                )}
                                                {isPercentage ? "%" : ""}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.christian,
                                                    isPercentage ? 2 : 0,
                                                )}
                                                {isPercentage ? "%" : ""}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.prakriti,
                                                    isPercentage ? 2 : 0,
                                                )}
                                                {isPercentage ? "%" : ""}
                                            </td>
                                            <td class="px-4 py-3">
                                                {formatNumber(
                                                    row.total,
                                                    isPercentage ? 2 : 0,
                                                )}
                                                {isPercentage ? "%" : ""}
                                            </td>
                                        </tr>
                                    );
                                })
                            }
                        </tbody>
                    </table>
                </div>
                <div
                    class="text-right text-zinc-400 font-serif italic text-sm mt-2"
                >
                    {lang === "ne" ? "स्रोत" : "Source"}: {content.source}
                </div>
            </div>

            <p
                class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-10 text-justify"
            >
                {content.content_final}
            </p>

            <!-- Professional Religion Chart -->
            <div
                class="mb-12 w-full bg-[#0a0a0a] border border-[#f2e25d]/10 p-8 rounded-xl overflow-hidden shadow-2xl"
            >
                <h4
                    class="font-serif text-2xl md:text-3xl text-white font-medium mb-12 text-center"
                >
                    {
                        lang === "ne"
                            ? "धर्मअनुसार जनसंख्याको विवरण"
                            : "Population Distribution by Religion"
                    }
                </h4>
                <div id="religion-3d-chart" class="w-full h-[500px] relative">
                </div>

                <!-- Legend -->
                <div class="flex flex-wrap justify-center gap-6 mt-8">
                    {
                        [
                            {
                                label: lang === "ne" ? "हिन्दू" : "Hindu",
                                color: "#ff0000",
                            },
                            {
                                label:
                                    lang === "ne" ? "बौद्ध मार्गी" : "Buddhist",
                                color: "#90EE90",
                            },
                            {
                                label: lang === "ne" ? "ईस्लाम" : "Islam",
                                color: "#0066cc",
                            },
                            {
                                label: lang === "ne" ? "किराँत" : "Kirat",
                                color: "#8B4513",
                            },
                            {
                                label:
                                    lang === "ne" ? "क्रिश्चियन" : "Christian",
                                color: "#663399",
                            },
                            {
                                label: lang === "ne" ? "प्रकृति" : "Prakriti",
                                color: "#D2691E",
                            },
                        ].map((item) => (
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-4 h-4 rounded-sm"
                                    style={`background-color: ${item.color}`}
                                />
                                <span class="text-zinc-300 font-serif text-sm md:text-base">
                                    {item.label}
                                </span>
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<script is:inline src="https://d3js.org/d3.v7.min.js"></script>
<script define:vars={{ content, lang }}>
    document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("religion-3d-chart");
        if (!container) return;

        const formatValue = (num, decimals = 0) => {
            const formatted = num.toLocaleString("en-US", {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals,
            });
            if (lang !== "ne") return formatted;
            const nepaliDigits = [
                "०",
                "१",
                "२",
                "३",
                "४",
                "५",
                "६",
                "७",
                "८",
                "९",
            ];
            return formatted.replace(
                /\d/g,
                (digit) => nepaliDigits[parseInt(digit)],
            );
        };

        // Extract data from total row
        const totalRow = content.table_data.find(
            (r) => r.gender === (lang === "ne" ? "जम्मा" : "Total"),
        );
        if (!totalRow) return;

        const nepaliToEnglish = (str) =>
            str.replace(
                /[०१२३४५६७८९]/g,
                (d) => "0123456789"["०१२३४५६७८९".indexOf(d)],
            );

        const data = [
            {
                label: lang === "ne" ? "हिन्दू" : "Hindu",
                value: parseInt(
                    nepaliToEnglish(totalRow.hindu.replace(/,/g, "")),
                ),
                color: "#ff0000",
            },
            {
                label: lang === "ne" ? "बौद्ध मार्गी" : "Buddhist",
                value: parseInt(
                    nepaliToEnglish(totalRow.buddhist.replace(/,/g, "")),
                ),
                color: "#90EE90",
            },
            {
                label: lang === "ne" ? "ईस्लाम" : "Islam",
                value: parseInt(
                    nepaliToEnglish(totalRow.islam.replace(/,/g, "")),
                ),
                color: "#0066cc",
            },
            {
                label: lang === "ne" ? "किराँत" : "Kirat",
                value: parseInt(
                    nepaliToEnglish(totalRow.kirat.replace(/,/g, "")),
                ),
                color: "#8B4513",
            },
            {
                label: lang === "ne" ? "क्रिश्चियन" : "Christian",
                value: parseInt(
                    nepaliToEnglish(totalRow.christian.replace(/,/g, "")),
                ),
                color: "#663399",
            },
            {
                label: lang === "ne" ? "प्रकृति" : "Prakriti",
                value: parseInt(
                    nepaliToEnglish(totalRow.prakriti.replace(/,/g, "")),
                ),
                color: "#D2691E",
            },
        ];

        const margin = { top: 40, right: 40, bottom: 60, left: 80 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        const svg = d3
            .select("#religion-3d-chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // X scale
        const x = d3
            .scaleBand()
            .range([0, width])
            .domain(data.map((d) => d.label))
            .padding(0.4);

        // Y scale
        const y = d3
            .scaleLinear()
            .domain([0, d3.max(data, (d) => d.value) * 1.1])
            .range([height, 0]);

        // Add Grid lines
        svg.append("g")
            .attr("class", "grid")
            .attr("opacity", 0.05)
            .call(d3.axisLeft(y).tickSize(-width).tickFormat(""));

        // X Axis
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("fill", "#94a3b8")
            .style("font-size", "14px")
            .style("font-family", "serif");

        // Y Axis
        svg.append("g")
            .call(d3.axisLeft(y).ticks(5))
            .selectAll("text")
            .attr("fill", "#94a3b8")
            .style("font-size", "14px")
            .style("font-family", "serif")
            .text((d) => formatValue(d));

        // Bars with 3D Effect using perspective and gradients
        const barGroups = svg
            .selectAll(".bar-group")
            .data(data)
            .enter()
            .append("g")
            .attr("class", "bar-group");

        barGroups.each(function (d, i) {
            const g = d3.select(this);
            const barWidth = x.bandwidth();
            const barHeight = height - y(d.value);
            const xPos = x(d.label);
            const yPos = y(d.value);

            const skew = 10;

            // Side face
            g.append("path")
                .attr("fill", d3.color(d.color).darker(0.8))
                .attr(
                    "d",
                    `M ${xPos + barWidth} ${height} L ${xPos + barWidth + skew} ${height - skew} L ${xPos + barWidth + skew} ${height - skew} L ${xPos + barWidth} ${height} Z`,
                )
                .transition()
                .duration(1200)
                .delay(i * 150)
                .attr(
                    "d",
                    `M ${xPos + barWidth} ${height} L ${xPos + barWidth + skew} ${height - skew} L ${xPos + barWidth + skew} ${yPos - skew} L ${xPos + barWidth} ${yPos} Z`,
                );

            // Top face
            g.append("path")
                .attr("fill", d3.color(d.color).brighter(0.4))
                .attr(
                    "d",
                    `M ${xPos} ${height} L ${xPos + skew} ${height - skew} L ${xPos + barWidth + skew} ${height - skew} L ${xPos + barWidth} ${height} Z`,
                )
                .transition()
                .duration(1200)
                .delay(i * 150)
                .attr(
                    "d",
                    `M ${xPos} ${yPos} L ${xPos + skew} ${yPos - skew} L ${xPos + barWidth + skew} ${yPos - skew} L ${xPos + barWidth} ${yPos} Z`,
                );

            // Front face
            g.append("rect")
                .attr("x", xPos)
                .attr("y", height)
                .attr("width", barWidth)
                .attr("height", 0)
                .attr("fill", d.color)
                .attr("stroke", "rgba(255,255,255,0.1)")
                .transition()
                .duration(1200)
                .delay(i * 150)
                .attr("y", yPos)
                .attr("height", barHeight);
        });

        // Tooltip interaction
        barGroups
            .style("cursor", "pointer")
            .on("mouseover", function (event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("transform", "translate(0, -5)");

                const tooltip = d3.select("#religion-tooltip");
                tooltip.transition().duration(200).style("opacity", 0.9);
                tooltip
                    .html(
                        `
                    <div class="font-serif p-2">
                        <div class="font-bold text-sm mb-1">${d.label}</div>
                        <div class="text-xs text-zinc-300">
                            ${lang === "ne" ? "संख्या" : "Number"}: ${formatValue(d.value)}
                        </div>
                    </div>
                `,
                    )
                    .style("left", event.clientX + 10 + "px")
                    .style("top", event.clientY - 28 + "px");
            })
            .on("mousemove", function (event) {
                d3.select("#religion-tooltip")
                    .style("left", event.clientX + 10 + "px")
                    .style("top", event.clientY - 28 + "px");
            })
            .on("mouseout", function () {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("transform", "translate(0, 0)");

                d3.select("#religion-tooltip")
                    .transition()
                    .duration(500)
                    .style("opacity", 0);
            });
        // Axis styling
        svg.selectAll(".domain").attr("stroke", "#475569");
        svg.selectAll(".tick line").attr("stroke", "#475569");
    });
</script>
