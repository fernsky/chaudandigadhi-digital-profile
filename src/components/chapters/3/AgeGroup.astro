---
import type { Language } from "../../../lib/i18n";
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";
import PopulationPyramidChart from "../../charts/chapter-3/PopulationPyramidChart.astro";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

const formatNumber = (val: string | number, decimals = 0) => {
    const nepaliToEnglish = (str: string) =>
        str.replace(
            /[०१२३४५६७८९]/g,
            (d) => "0123456789"["०१२३४५६७८९".indexOf(d)],
        );

    let num: number;
    if (typeof val === "string") {
        const cleaned = val.replace(/,/g, "");
        num = parseFloat(nepaliToEnglish(cleaned));
    } else {
        num = val;
    }

    if (isNaN(num)) return val.toString();

    const formatted = num.toLocaleString("en-US", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals,
    });

    if (lang !== "ne") return formatted;

    const nepaliDigits = ["०", "१", "२", "३", "४", "५", "६", "७", "८", "९"];
    return formatted.replace(/\d/g, (digit) => nepaliDigits[parseInt(digit)]);
};

type AgeGroupContent = {
    title: string;
    number: string;
    table_title: string;
    table_number: string;
    source: string;
    content_after_table: string;
    chart_title: string;
    content_after_chart: string;
    table_data: Array<{
        age_group: string;
        male: string;
        female: string;
        total: string;
    }>;
};

const content = await loadChapterSection<AgeGroupContent>(3, "age-group", lang);

if (!content) {
    throw new Error("Age Group section content not found");
}
---

<section
    id="age-gender-distribution"
    class="relative bg-[#050505] pb-8 md:pb-12 border-t border-[#f2e25d]/10 pt-8 mt-8"
>
    <div class="container mx-auto px-8">
        <div class="w-full">
            <!-- 3.3 Header -->
            <div class="mb-8">
                <h3
                    class="font-serif text-2xl md:text-3xl font-medium text-zinc-100 mb-6"
                >
                    {content.number}
                    {content.title}
                </h3>
            </div>

            <!-- Table -->
            <div class="mb-10 w-full overflow-hidden">
                <h4
                    class="font-serif text-xl md:text-2xl text-zinc-100 font-medium mb-4 text-center"
                >
                    {content.table_number}: {content.table_title}
                </h4>
                <div class="overflow-x-auto">
                    <table
                        class="w-full border-collapse bg-[#0a0a0a] border border-[#f2e25d]/10 text-sm md:text-lg text-center"
                    >
                        <thead>
                            <tr
                                class="bg-[#f2e25d]/5 border-b border-[#f2e25d]/20 text-zinc-100"
                            >
                                <th
                                    class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                >
                                    {lang === "ne" ? "उमेर समूह" : "Age Group"}
                                </th>
                                <th
                                    class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                >
                                    {lang === "ne" ? "पुरूष" : "Male"}
                                </th>
                                <th
                                    class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                >
                                    {lang === "ne" ? "महिला" : "Female"}
                                </th>
                                <th class="px-4 py-3 font-serif font-medium">
                                    {lang === "ne" ? "जम्मा" : "Total"}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {
                                content.table_data.map((row) => {
                                    const isTotal =
                                        row.age_group === "जम्मा" ||
                                        row.age_group === "Total";
                                    return (
                                        <tr
                                            class={`border-b border-[#f2e25d]/5 hover:bg-[#f2e25d]/5 transition-colors duration-200 text-zinc-100 font-serif ${isTotal ? "bg-[#f2e25d]/10 font-bold border-t-2 border-[#f2e25d]/30" : ""}`}
                                        >
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5 font-medium">
                                                {row.age_group}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.male)}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.female)}
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                {formatNumber(row.total)}
                                            </td>
                                        </tr>
                                    );
                                })
                            }
                        </tbody>
                    </table>
                </div>
                <div
                    class="text-right text-zinc-400 font-serif italic text-sm mt-2"
                >
                    {lang === "ne" ? "स्रोत" : "Source"}: {content.source}
                </div>
            </div>

            <!-- Paragraph After Table -->
            <p
                class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-10 text-justify"
            >
                {content.content_after_table}
            </p>

            <!-- Chart -->
            <div
                class="mb-10 w-full bg-[#0a0a0a] border border-[#f2e25d]/10 p-6 rounded-lg"
            >
                <h4
                    class="font-bold text-xl md:text-2xl text-white font-medium mb-6 text-center font-serif"
                >
                    {content.chart_title}
                </h4>
                <PopulationPyramidChart lang={lang} />
            </div>

            <!-- Paragraph After Chart -->
            <p
                class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-6 text-justify"
            >
                {content.content_after_chart}
            </p>
        </div>
    </div>
</section>
