---
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";
import type { Language } from "../../../lib/i18n";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

const formatNumber = (num: number, decimals = 0) => {
    const formatted = num.toLocaleString("en-US", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals,
    });
    if (lang !== "ne") return formatted;
    const nepaliDigits = ["०", "१", "२", "३", "४", "५", "६", "७", "८", "९"];
    return formatted.replace(/\d/g, (digit) => nepaliDigits[parseInt(digit)]);
};

type MigrationContent = {
    title: string;
    sectionId: string;
    number: string;
    intro: string;
    subsections: {
        birthplace: {
            title: string;
            tableTitle: string;
            tableData: Array<{
                ageGroup: string;
                withinNepal: number;
                thisMunicipality: number;
                otherMunicipality: number;
                anotherDistrictHills: number;
                anotherDistrictMountains: number;
                anotherDistrictTerai: number;
                anotherDistrictTotal: number;
                foreign: number;
                undisclosed: number;
                total: number;
            }>;
            total: {
                withinNepal: number;
                thisMunicipality: number;
                otherMunicipality: number;
                anotherDistrictHills: number;
                anotherDistrictMountains: number;
                anotherDistrictTerai: number;
                anotherDistrictTotal: number;
                foreign: number;
                undisclosed: number;
                total: number;
            };
            chartTitle: string;
            chartData: Array<{
                label: string;
                value: number;
                color: string;
            }>;
            source: string;
        };
        previousResidence: {
            title: string;
            tableTitle: string;
            tableData: Array<{
                type: string;
                male: number;
                female: number;
                total: number;
                percentage: number;
            }>;
            total: {
                male: number;
                female: number;
                total: number;
                percentage: number;
            };
            source: string;
            analysis: string;
        };
    };
};

const content = await loadChapterSection<MigrationContent>(
    3,
    "migration",
    lang,
);

if (!content) {
    throw new Error("Migration section content not found");
}

const { birthplace, previousResidence } = content.subsections;
---

<section
    id="migration"
    class="relative bg-[#050505] pb-8 md:pb-12 border-t border-[#f2e25d]/10 pt-8 mt-8"
>
    <div class="container mx-auto px-8">
        <div class="w-full">
            <!-- 3.11 Header -->
            <div class="mb-8">
                <h3
                    class="font-serif text-2xl md:text-3xl font-medium text-zinc-100 mb-6"
                >
                    {content.title}
                </h3>
            </div>

            <p
                class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-10 text-justify"
            >
                {content.intro}
            </p>

            <!-- Subsection A: Birthplace -->
            <div class="mb-12">
                <h4
                    class="font-serif text-xl md:text-2xl font-medium text-white mb-6"
                >
                    {birthplace.title}
                </h4>

                <!-- Table 16 -->
                <div class="mb-12 w-full overflow-hidden">
                    <h5
                        class="font-serif text-lg md:text-xl text-zinc-100 font-medium mb-4 text-center"
                    >
                        {birthplace.tableTitle}
                    </h5>
                    <div class="overflow-x-auto">
                        <table
                            class="w-full border-collapse bg-[#0a0a0a] border border-[#f2e25d]/10 text-[10px] md:text-xs text-center"
                        >
                            <thead>
                                <tr
                                    class="bg-[#f2e25d]/20 border-b border-[#f2e25d]/20 text-white"
                                >
                                    <th
                                        rowspan="2"
                                        class="px-1 py-3 border-r border-[#f2e25d]/10 font-serif font-medium sticky left-0 bg-[#1a1a14] z-10 min-w-[80px]"
                                    >
                                        {
                                            lang === "ne"
                                                ? "उमेर समूह"
                                                : "Age Group"
                                        }
                                    </th>
                                    <th
                                        rowspan="2"
                                        class="px-1 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                    >
                                        {
                                            lang === "ne"
                                                ? "नेपाल भित्र जन्मेको संख्या"
                                                : "Born within Nepal"
                                        }
                                    </th>
                                    <th
                                        colspan="2"
                                        class="px-1 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                    >
                                        {
                                            lang === "ne"
                                                ? "यही जिल्लामा जन्मेको संख्या"
                                                : "Born in this District"
                                        }
                                    </th>
                                    <th
                                        colspan="4"
                                        class="px-1 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                    >
                                        {
                                            lang === "ne"
                                                ? "अर्को जिल्लामा जन्मेको"
                                                : "Born in another District"
                                        }
                                    </th>
                                    <th
                                        rowspan="2"
                                        class="px-1 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                    >
                                        {
                                            lang === "ne"
                                                ? "विदेशमा जन्मेको"
                                                : "Born Abroad"
                                        }
                                    </th>
                                    <th
                                        rowspan="2"
                                        class="px-1 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                    >
                                        {
                                            lang === "ne"
                                                ? "जन्म स्थान नखुलेको"
                                                : "Undisclosed"
                                        }
                                    </th>
                                    <th
                                        rowspan="2"
                                        class="px-1 py-3 font-serif font-medium"
                                    >
                                        {
                                            lang === "ne"
                                                ? "जम्मा जनसंख्या"
                                                : "Total Population"
                                        }
                                    </th>
                                </tr>
                                <tr
                                    class="bg-[#f2e25d]/10 border-b border-[#f2e25d]/20 text-zinc-100"
                                >
                                    <th
                                        class="px-1 py-2 border-r border-[#f2e25d]/10 font-serif font-medium"
                                        >{
                                            lang === "ne"
                                                ? "यही नगरपालिकामा"
                                                : "This Municipality"
                                        }</th
                                    >
                                    <th
                                        class="px-1 py-2 border-r border-[#f2e25d]/10 font-serif font-medium"
                                        >{
                                            lang === "ne"
                                                ? "अर्को पालिकामा"
                                                : "Other Municipality"
                                        }</th
                                    >
                                    <th
                                        class="px-1 py-2 border-r border-[#f2e25d]/10 font-serif font-medium"
                                        >{lang === "ne" ? "पहाड" : "Hills"}</th
                                    >
                                    <th
                                        class="px-1 py-2 border-r border-[#f2e25d]/10 font-serif font-medium"
                                        >{
                                            lang === "ne"
                                                ? "हिमाल"
                                                : "Mountains"
                                        }</th
                                    >
                                    <th
                                        class="px-1 py-2 border-r border-[#f2e25d]/10 font-serif font-medium"
                                        >{lang === "ne" ? "तराई" : "Terai"}</th
                                    >
                                    <th
                                        class="px-1 py-2 border-r border-[#f2e25d]/10 font-serif font-medium"
                                        >{lang === "ne" ? "जम्मा" : "Total"}</th
                                    >
                                </tr>
                            </thead>
                            <tbody class="text-zinc-300 font-serif">
                                {
                                    birthplace.tableData.map((row) => (
                                        <tr class="border-b border-[#f2e25d]/5 hover:bg-[#f2e25d]/5 transition-colors duration-200">
                                            <td class="px-1 py-2 border-r border-[#f2e25d]/5 font-medium text-left sticky left-0 bg-[#0a0a0a] z-10">
                                                {row.ageGroup}
                                            </td>
                                            <td class="px-1 py-2 border-r border-[#f2e25d]/5">
                                                {formatNumber(row.withinNepal)}
                                            </td>
                                            <td class="px-1 py-2 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.thisMunicipality,
                                                )}
                                            </td>
                                            <td class="px-1 py-2 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.otherMunicipality,
                                                )}
                                            </td>
                                            <td class="px-1 py-2 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.anotherDistrictHills,
                                                )}
                                            </td>
                                            <td class="px-1 py-2 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.anotherDistrictMountains,
                                                )}
                                            </td>
                                            <td class="px-1 py-2 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.anotherDistrictTerai,
                                                )}
                                            </td>
                                            <td class="px-1 py-2 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    row.anotherDistrictTotal,
                                                )}
                                            </td>
                                            <td class="px-1 py-2 border-r border-[#f2e25d]/5">
                                                {formatNumber(row.foreign)}
                                            </td>
                                            <td class="px-1 py-2 border-r border-[#f2e25d]/5">
                                                {formatNumber(row.undisclosed)}
                                            </td>
                                            <td class="px-1 py-2 font-medium text-white bg-[#f2e25d]/5">
                                                {formatNumber(row.total)}
                                            </td>
                                        </tr>
                                    ))
                                }
                                <tr
                                    class="bg-[#f2e25d]/20 font-bold text-white uppercase text-[9px] md:text-[11px]"
                                >
                                    <td
                                        class="px-1 py-3 border-r border-[#f2e25d]/10 text-left sticky left-0 bg-[#1a1a14] z-10"
                                    >
                                        {lang === "ne" ? "जम्मा" : "Total"}
                                    </td>
                                    <td
                                        class="px-1 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                birthplace.total.withinNepal,
                                            )
                                        }</td
                                    >
                                    <td
                                        class="px-1 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                birthplace.total
                                                    .thisMunicipality,
                                            )
                                        }</td
                                    >
                                    <td
                                        class="px-1 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                birthplace.total
                                                    .otherMunicipality,
                                            )
                                        }</td
                                    >
                                    <td
                                        class="px-1 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                birthplace.total
                                                    .anotherDistrictHills,
                                            )
                                        }</td
                                    >
                                    <td
                                        class="px-1 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                birthplace.total
                                                    .anotherDistrictMountains,
                                            )
                                        }</td
                                    >
                                    <td
                                        class="px-1 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                birthplace.total
                                                    .anotherDistrictTerai,
                                            )
                                        }</td
                                    >
                                    <td
                                        class="px-1 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                birthplace.total
                                                    .anotherDistrictTotal,
                                            )
                                        }</td
                                    >
                                    <td
                                        class="px-1 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                birthplace.total.foreign,
                                            )
                                        }</td
                                    >
                                    <td
                                        class="px-1 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                birthplace.total.undisclosed,
                                            )
                                        }</td
                                    >
                                    <td class="px-1 py-3"
                                        >{
                                            formatNumber(birthplace.total.total)
                                        }</td
                                    >
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div
                        class="text-right text-zinc-400 font-serif italic text-sm mt-2"
                    >
                        {lang === "ne" ? "स्रोत" : "Source"}: {
                            birthplace.source
                        }
                    </div>
                </div>

                <!-- D3 3D-Style Birthplace Chart -->
                <div
                    class="mb-16 w-full bg-[#0a0a0a] border border-[#f2e25d]/10 p-4 md:p-8 rounded-xl shadow-2xl relative overflow-hidden"
                >
                    <h4
                        class="font-serif text-xl md:text-2xl text-white font-medium mb-12 text-center px-4"
                    >
                        {birthplace.chartTitle}
                    </h4>
                    <div
                        id="birthplace-3d-chart"
                        class="w-full h-[400px] md:h-[500px]"
                    >
                    </div>

                    <div
                        class="flex flex-wrap justify-center gap-4 md:gap-x-8 md:gap-y-4 mt-8 max-w-4xl mx-auto"
                    >
                        {
                            birthplace.chartData.map((d) => (
                                <div class="flex items-center gap-2">
                                    <div
                                        class="w-3 h-3 md:w-4 md:h-4 rounded-sm"
                                        style={`background-color: ${d.color}`}
                                    />
                                    <span class="text-zinc-300 font-serif text-[10px] md:text-sm whitespace-nowrap">
                                        {d.label}
                                    </span>
                                </div>
                            ))
                        }
                    </div>
                </div>
            </div>

            <!-- Subsection B: Previous Residence -->
            <div class="mb-12">
                <h4
                    class="font-serif text-xl md:text-2xl font-medium text-white mb-6"
                >
                    {previousResidence.title}
                </h4>

                <!-- Table 17 -->
                <div class="mb-8 w-full overflow-hidden">
                    <h5
                        class="font-serif text-lg md:text-xl text-zinc-100 font-medium mb-4 text-center"
                    >
                        {previousResidence.tableTitle}
                    </h5>
                    <div class="overflow-x-auto">
                        <table
                            class="w-full border-collapse bg-[#0a0a0a] border border-[#f2e25d]/10 text-xs md:text-sm text-center"
                        >
                            <thead>
                                <tr
                                    class="bg-[#f2e25d]/20 border-b border-[#f2e25d]/20 text-white"
                                >
                                    <th
                                        class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                        >{
                                            lang === "ne"
                                                ? "बसाइँसराईको किसिम"
                                                : "Migration Type"
                                        }</th
                                    >
                                    <th
                                        class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                        >{lang === "ne" ? "पुरुष" : "Male"}</th
                                    >
                                    <th
                                        class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                        >{
                                            lang === "ne" ? "महिला" : "Female"
                                        }</th
                                    >
                                    <th
                                        class="px-4 py-3 border-r border-[#f2e25d]/10 font-serif font-medium"
                                        >{lang === "ne" ? "कुल" : "Total"}</th
                                    >
                                    <th class="px-4 py-3 font-serif font-medium"
                                        >{
                                            lang === "ne"
                                                ? "प्रतिशत"
                                                : "Percentage"
                                        }</th
                                    >
                                </tr>
                            </thead>
                            <tbody class="text-zinc-300 font-serif">
                                {
                                    previousResidence.tableData.map((row) => (
                                        <tr class="border-b border-[#f2e25d]/5 hover:bg-[#f2e25d]/5 transition-colors duration-200">
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5 text-left font-medium">
                                                {row.type}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5">
                                                {formatNumber(row.male)}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5">
                                                {formatNumber(row.female)}
                                            </td>
                                            <td class="px-4 py-3 border-r border-[#f2e25d]/5">
                                                {formatNumber(row.total)}
                                            </td>
                                            <td class="px-4 py-3">
                                                {formatNumber(
                                                    row.percentage,
                                                    2,
                                                )}
                                                %
                                            </td>
                                        </tr>
                                    ))
                                }
                                <tr
                                    class="bg-[#f2e25d]/10 font-bold text-white"
                                >
                                    <td
                                        class="px-4 py-3 border-r border-[#f2e25d]/10 text-left"
                                        >{lang === "ne" ? "जम्मा" : "Total"}</td
                                    >
                                    <td
                                        class="px-4 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                previousResidence.total.male,
                                            )
                                        }</td
                                    >
                                    <td
                                        class="px-4 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                previousResidence.total.female,
                                            )
                                        }</td
                                    >
                                    <td
                                        class="px-4 py-3 border-r border-[#f2e25d]/10"
                                        >{
                                            formatNumber(
                                                previousResidence.total.total,
                                            )
                                        }</td
                                    >
                                    <td class="px-4 py-3"
                                        >{
                                            formatNumber(
                                                previousResidence.total
                                                    .percentage,
                                                2,
                                            )
                                        }%</td
                                    >
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <p
                    class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-6 text-justify"
                >
                    {previousResidence.analysis}
                </p>
                <div
                    class="text-right text-zinc-400 font-serif italic text-sm mt-2"
                >
                    {lang === "ne" ? "स्रोत" : "Source"}: {
                        previousResidence.source
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<script is:inline src="https://d3js.org/d3.v7.min.js"></script>
<script define:vars={{ chartData: birthplace.chartData, lang }}>
    document.addEventListener("DOMContentLoaded", () => {
        const draw3DChart = () => {
            const container = document.getElementById("birthplace-3d-chart");
            if (!container) return;
            container.innerHTML = "";

            const formatValue = (num, decimals = 0) => {
                const formatted = num.toLocaleString("en-US", {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals,
                });
                if (lang !== "ne") return formatted;
                const nepaliDigits = [
                    "०",
                    "१",
                    "२",
                    "३",
                    "४",
                    "५",
                    "६",
                    "७",
                    "८",
                    "९",
                ];
                return formatted.replace(
                    /\d/g,
                    (digit) => nepaliDigits[parseInt(digit)],
                );
            };

            const margin = { top: 60, right: 30, bottom: 60, left: 70 };
            const width = container.clientWidth - margin.left - margin.right;
            const height =
                (container.clientHeight || 500) - margin.top - margin.bottom;

            const svg = d3
                .select("#birthplace-3d-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3
                .scaleBand()
                .range([0, width])
                .padding(0.4)
                .domain(chartData.map((d) => d.label));

            const y = d3
                .scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(chartData, (d) => d.value) * 1.1]);

            // Add grid lines
            svg.append("g")
                .attr("class", "grid")
                .attr("opacity", 0.1)
                .call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(""));

            const depth = width < 600 ? 15 : 30;

            chartData.forEach((d, i) => {
                const barWidth = x.bandwidth();
                const barHeight = height - y(d.value);
                const barX = x(d.label);
                const barY = y(d.value);

                const g = svg.append("g").attr("class", "bar-group");

                // Side face
                g.append("path")
                    .attr("fill", d3.color(d.color).darker(0.8))
                    .attr(
                        "d",
                        `M ${barX + barWidth} ${height} L ${barX + barWidth + depth} ${height - depth} L ${barX + barWidth + depth} ${height - depth} L ${barX + barWidth} ${height} Z`,
                    )
                    .transition()
                    .duration(1200)
                    .attr(
                        "d",
                        `M ${barX + barWidth} ${height} L ${barX + barWidth + depth} ${height - depth} L ${barX + barWidth + depth} ${barY - depth} L ${barX + barWidth} ${barY} Z`,
                    );

                // Top face
                g.append("path")
                    .attr("fill", d3.color(d.color).brighter(0.4))
                    .attr(
                        "d",
                        `M ${barX} ${height} L ${barX + depth} ${height - depth} L ${barX + barWidth + depth} ${height - depth} L ${barX + barWidth} ${height} Z`,
                    )
                    .transition()
                    .duration(1200)
                    .attr(
                        "d",
                        `M ${barX} ${barY} L ${barX + depth} ${barY - depth} L ${barX + barWidth + depth} ${barY - depth} L ${barX + barWidth} ${barY} Z`,
                    );

                // Front face
                g.append("rect")
                    .attr("x", barX)
                    .attr("y", height)
                    .attr("width", barWidth)
                    .attr("height", 0)
                    .attr("fill", d.color)
                    .transition()
                    .duration(1200)
                    .attr("y", barY)
                    .attr("height", barHeight);

                // Tooltip interaction
                g.style("cursor", "pointer")
                    .on("mouseover", function (event) {
                        d3.select(this)
                            .selectAll("rect, path")
                            .transition()
                            .duration(200)
                            .attr("opacity", 0.8);

                        const tooltip = d3.select("#migration-tooltip");
                        tooltip
                            .transition()
                            .duration(200)
                            .style("opacity", 0.9);
                        tooltip
                            .html(
                                `
                            <div class="font-serif p-2">
                                <div class="font-bold text-sm mb-1">${d.label}</div>
                                <div class="text-xs text-zinc-300">
                                    ${lang === "ne" ? "संख्या" : "Number"}: ${formatValue(d.value)}
                                </div>
                            </div>
                        `,
                            )
                            .style("left", event.clientX + 10 + "px")
                            .style("top", event.clientY - 28 + "px");
                    })
                    .on("mousemove", function (event) {
                        d3.select("#migration-tooltip")
                            .style("left", event.clientX + 10 + "px")
                            .style("top", event.clientY - 28 + "px");
                    })
                    .on("mouseout", function () {
                        d3.select(this)
                            .selectAll("rect, path")
                            .transition()
                            .duration(200)
                            .attr("opacity", 1);

                        d3.select("#migration-tooltip")
                            .transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
            });

            // Axes
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("fill", "#94a3b8")
                .style("text-anchor", "middle")
                .attr("dy", "2em")
                .style("font-size", width < 600 ? "8px" : "12px")
                .attr("class", "font-serif");

            svg.append("g")
                .call(d3.axisLeft(y).ticks(5))
                .selectAll("text")
                .attr("fill", "#94a3b8")
                .attr("class", "font-serif")
                .text((d) => formatValue(d));

            svg.selectAll(".domain, .tick line").attr(
                "stroke",
                "rgba(255,255,255,0.1)",
            );
        };
        draw3DChart();
        window.addEventListener("resize", draw3DChart);
    });
</script>

<div
    id="migration-tooltip"
    class="fixed opacity-0 pointer-events-none bg-[#111111] border border-[#f2e25d]/30 text-white rounded px-2 py-1 z-[9999] shadow-2xl"
>
</div>

<style is:global>
    #migration-tooltip {
        transition: opacity 0.2s;
        backdrop-filter: blur(4px);
    }
</style>

<style>
    .grid line {
        stroke: #444;
    }
    .grid path {
        stroke-width: 0;
    }
</style>
