---
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";
import { formatNumber } from "../../../lib/i18n/formatters";
import type { Language } from "../../../lib/i18n";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

type DisabilityContent = {
    title: string;
    sectionId: string;
    number: string;
    intro: string;
    intro_2?: string;
    subsectionTitle: string;
    subsectionContent: string;
    tableTitle: string;
    tableData: Array<{
        ageGroup: string;
        physical: number;
        lowVision: number;
        blind: number;
        deaf: number;
        hardHearing: number;
        deafBlind: number;
        speech: number;
        mental: number;
        intellectual: number;
        hemophilia: number;
        autism: number;
        multiple: number;
        total: number;
    }>;
    total: {
        physical: number;
        lowVision: number;
        blind: number;
        deaf: number;
        hardHearing: number;
        deafBlind: number;
        speech: number;
        mental: number;
        intellectual: number;
        hemophilia: number;
        autism: number;
        multiple: number;
        total: number;
    };
    source: string;
    columns: {
        [key: string]: string;
    };
    chartTitle: string;
    chartData: Array<{
        label: string;
        value: number;
        color: string;
    }>;
};

const content = await loadChapterSection<DisabilityContent>(
    3,
    "disability",
    lang,
);

if (!content) {
    throw new Error("Disability section content not found");
}

const tableKeys = [
    "physical",
    "lowVision",
    "blind",
    "deaf",
    "hardHearing",
    "deafBlind",
    "speech",
    "mental",
    "intellectual",
    "hemophilia",
    "autism",
    "multiple",
];
---

<section
    id="disability"
    class="relative bg-[#050505] pb-8 md:pb-12 border-t border-[#f2e25d]/10 pt-8 mt-8"
>
    <div class="container mx-auto px-8">
        <div class="w-full">
            <!-- 3.10 Header -->
            <div class="mb-8">
                <h3
                    class="font-serif text-2xl md:text-3xl font-medium text-zinc-100 mb-6"
                >
                    {content.title}
                </h3>
            </div>

            <p
                class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-6 text-justify"
            >
                {content.intro}
            </p>

            {
                content.intro_2 && (
                    <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-10 text-justify">
                        {content.intro_2}
                    </p>
                )
            }

            <!-- Subsection -->
            <div class="mb-8">
                <h4
                    class="font-serif text-xl md:text-2xl font-medium text-white mb-6"
                >
                    {content.subsectionTitle}
                </h4>
                <p
                    class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-10 text-justify"
                >
                    {content.subsectionContent}
                </p>
            </div>

            <!-- Table 15 -->
            <div class="mb-12 w-full overflow-hidden">
                <h4
                    class="font-serif text-xl md:text-2xl text-zinc-100 font-medium mb-4 text-center"
                >
                    {content.tableTitle}
                </h4>
                <div class="overflow-x-auto">
                    <table
                        class="w-full border-collapse bg-[#0a0a0a] border border-[#f2e25d]/10 text-[10px] md:text-xs text-center"
                    >
                        <thead>
                            <tr
                                class="bg-[#f2e25d]/10 border-b border-[#f2e25d]/20 text-zinc-100"
                            >
                                <th
                                    class="px-1 py-3 border-r border-[#f2e25d]/10 font-serif font-medium sticky left-0 bg-[#0a0a0a] z-10 min-w-[80px]"
                                >
                                    {lang === "ne" ? "उमेर समूह" : "Age Group"}
                                </th>
                                {
                                    tableKeys.map((key) => (
                                        <th class="px-1 py-3 border-r border-[#f2e25d]/10 font-serif font-medium min-w-[60px]">
                                            {content.columns[key]}
                                        </th>
                                    ))
                                }
                                <th class="px-1 py-3 font-serif font-medium">
                                    {lang === "ne" ? "जम्मा" : "Total"}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="text-zinc-300 font-serif">
                            {
                                content.tableData.map((row) => (
                                    <tr class="border-b border-[#f2e25d]/5 hover:bg-[#f2e25d]/5 transition-colors duration-200">
                                        <td class="px-1 py-3 border-r border-[#f2e25d]/5 font-medium text-left sticky left-0 bg-[#0a0a0a] z-10">
                                            {row.ageGroup}
                                        </td>
                                        {tableKeys.map((key) => (
                                            <td class="px-1 py-3 border-r border-[#f2e25d]/5">
                                                {formatNumber(
                                                    (row[
                                                        key as keyof typeof row
                                                    ] as number) || 0,
                                                    lang,
                                                )}
                                            </td>
                                        ))}
                                        <td class="px-1 py-3 font-medium text-white bg-[#f2e25d]/5">
                                            {formatNumber(row.total, lang)}
                                        </td>
                                    </tr>
                                ))
                            }
                            <tr class="bg-[#f2e25d]/20 font-bold text-white">
                                <td
                                    class="px-1 py-3 border-r border-[#f2e25d]/10 text-left sticky left-0 bg-[#333] z-10"
                                >
                                    {lang === "ne" ? "जम्मा" : "Total"}
                                </td>
                                {
                                    tableKeys.map((key) => (
                                        <td class="px-1 py-3 border-r border-[#f2e25d]/10">
                                            {formatNumber(
                                                content.total[
                                                    key as keyof typeof content.total
                                                ] as number,
                                                lang,
                                            )}
                                        </td>
                                    ))
                                }
                                <td class="px-1 py-3">
                                    {formatNumber(content.total.total, lang)}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div
                    class="text-right text-zinc-400 font-serif italic text-sm mt-2"
                >
                    {lang === "ne" ? "स्रोत" : "Source"}: {content.source}
                </div>
            </div>

            <!-- D3 Pie Chart -->
            <div
                class="mb-16 w-full bg-[#0a0a0a] border border-[#f2e25d]/10 p-4 md:p-8 rounded-xl shadow-2xl relative overflow-hidden"
            >
                <h4
                    class="font-serif text-xl md:text-2xl text-white font-medium mb-12 text-center px-4"
                >
                    {content.chartTitle}
                </h4>
                <div
                    id="disability-pie-chart"
                    class="w-full h-[500px] md:h-[600px]"
                >
                </div>

                <div
                    class="flex flex-wrap justify-center gap-4 md:gap-x-8 md:gap-y-4 mt-8 max-w-4xl mx-auto"
                >
                    {
                        content.chartData.map((d) => (
                            <div class="flex items-center gap-2 min-w-[150px]">
                                <div
                                    class="w-3 h-3 md:w-4 md:h-4 rounded-full shadow-[0_0_10px_rgba(255,255,255,0.1)]"
                                    style={`background-color: ${d.color}`}
                                />
                                <span class="text-zinc-300 font-serif text-[10px] md:text-sm whitespace-nowrap">
                                    {d.label}
                                </span>
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<script is:inline src="https://d3js.org/d3.v7.min.js"></script>
<script define:vars={{ chartData: content.chartData, lang }}>
    document.addEventListener("DOMContentLoaded", () => {
        const drawPie = () => {
            const container = document.getElementById("disability-pie-chart");
            if (!container) return;
            container.innerHTML = "";

            const formatValue = (num, decimals = 0) => {
                const formatted = num.toLocaleString("en-US", {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals,
                });
                if (lang !== "ne") return formatted;
                const nepaliDigits = [
                    "०",
                    "१",
                    "२",
                    "३",
                    "४",
                    "५",
                    "६",
                    "७",
                    "८",
                    "९",
                ];
                return formatted.replace(
                    /\d/g,
                    (digit) => nepaliDigits[parseInt(digit)],
                );
            };

            const width = container.clientWidth;
            const height = container.clientHeight || 500;
            const radius = Math.min(width, height) / 2 - 60;

            const svg = d3
                .select("#disability-pie-chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            // Add drop shadow filter
            const defs = svg.append("defs");
            const filter = defs
                .append("filter")
                .attr("id", "drop-shadow")
                .attr("height", "130%");
            filter
                .append("feGaussianBlur")
                .attr("in", "SourceAlpha")
                .attr("stdDeviation", 3)
                .attr("result", "blur");
            filter
                .append("feOffset")
                .attr("in", "blur")
                .attr("dx", 2)
                .attr("dy", 2)
                .attr("result", "offsetBlur");
            const feMerge = filter.append("feMerge");
            feMerge.append("feMergeNode").attr("in", "offsetBlur");
            feMerge.append("feMergeNode").attr("in", "SourceGraphic");

            const pie = d3
                .pie()
                .value((d) => d.value)
                .sort(null);

            const arc = d3
                .arc()
                .innerRadius(radius * 0.4)
                .outerRadius(radius);

            const hoverArc = d3
                .arc()
                .innerRadius(radius * 0.4)
                .outerRadius(radius * 1.1);

            const arcs = svg
                .selectAll(".arc")
                .data(pie(chartData))
                .enter()
                .append("g")
                .attr("class", "arc");

            const paths = arcs
                .append("path")
                .attr("d", arc)
                .attr("fill", (d) => d.data.color)
                .attr("stroke", "#0a0a0a")
                .attr("stroke-width", "2px")
                .attr("filter", "url(#drop-shadow)")
                .style("cursor", "pointer")
                .style("opacity", 0.9);

            // Entry Animation
            paths
                .transition()
                .duration(1500)
                .attrTween("d", function (d) {
                    const i = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
                    return function (t) {
                        return arc(i(t));
                    };
                });

            // Interactive Effects
            paths
                .on("mouseover", function (event, d) {
                    d3.select(this)
                        .transition()
                        .duration(400)
                        .attr("d", hoverArc)
                        .style("opacity", 1)
                        .attr("stroke-width", "3px");

                    const tooltip = d3.select("#disability-tooltip");
                    tooltip.transition().duration(200).style("opacity", 0.9);
                    tooltip
                        .html(
                            `
                        <div class="font-serif p-2">
                            <div class="font-bold text-sm mb-1">${d.data.label}</div>
                            <div class="text-xs text-zinc-300">
                                ${lang === "ne" ? "प्रतिशत" : "Percentage"}: ${formatValue(d.data.value, 1)}%
                            </div>
                        </div>
                    `,
                        )
                        .style("left", event.clientX + 10 + "px")
                        .style("top", event.clientY - 28 + "px");
                })
                .on("mousemove", function (event) {
                    d3.select("#disability-tooltip")
                        .style("left", event.clientX + 10 + "px")
                        .style("top", event.clientY - 28 + "px");
                })
                .on("mouseout", function (event, d) {
                    d3.select(this)
                        .transition()
                        .duration(400)
                        .attr("d", arc)
                        .style("opacity", 0.9)
                        .attr("stroke-width", "2px");

                    d3.select("#disability-tooltip")
                        .transition()
                        .duration(500)
                        .style("opacity", 0);
                });
        };

        drawPie();
        window.addEventListener("resize", drawPie);
    });
</script>

<div
    id="disability-tooltip"
    class="fixed opacity-0 pointer-events-none bg-[#111111] border border-[#f2e25d]/30 text-white rounded px-2 py-1 z-[9999] shadow-2xl"
>
</div>

<style is:global>
    #disability-tooltip {
        transition: opacity 0.2s;
        backdrop-filter: blur(4px);
    }
</style>
