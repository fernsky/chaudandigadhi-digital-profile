---
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";
import type { Language } from "../../../lib/i18n";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

type EnergySection = {
    title: string;
    number: string;
    content1: string;
    content2: string;
    equationIntro: string;
    equation: string;
    content3: string;
};

type CookingFuelSection = {
    title: string;
    number: string;
    content: string;
    tableTitle: string;
    tableData: Array<{
        ward: string;
        wood: string;
        lpg: string;
        electricity: string;
        guitha: string;
        biogas: string;
        kerosene: string;
        others: string;
        total: string;
    }>;
    source: string;
    chartTitle: string;
    chartData: Array<{ label: string; value: number; color: string }>;
    content2: string;
};

type LightingFuelSection = {
    title: string;
    number: string;
    content: string;
    tableTitle: string;
    tableData: Array<{
        ward: string;
        electricity: string;
        solar: string;
        kerosene: string;
        biogas: string;
        others: string;
        total: string;
    }>;
    source: string;
    content2: string;
    chartTitle: string;
    chartData: Array<{ label: string; value: number; color: string }>;
};

type AlternativeEnergySection = {
    title: string;
    number: string;
    content: string;
};

const energy = (await loadChapterSection(
    7,
    "energy",
    lang
)) as EnergySection;

const cookingFuel = (await loadChapterSection(
    7,
    "cooking-fuel",
    lang
)) as CookingFuelSection;

const lightingFuel = (await loadChapterSection(
    7,
    "lighting-fuel",
    lang
)) as LightingFuelSection;

const alternativeEnergy = (await loadChapterSection(
    7,
    "alternative-energy",
    lang
)) as AlternativeEnergySection;

const equationHtml = energy?.equation
    ? energy.equation
          .replace(/\\times/g, "×")
          .replace(
              /\\frac{([^}]+)}{([^}]+)}/g,
              '<span class="inline-flex flex-col items-center align-middle mx-1"><span class="border-b border-[#f2e25d] pb-0.5">$1</span><span class="pt-0.5">$2</span></span>'
          )
    : "";
---

{
    energy && (
        <section
            id="electricity"
            class="relative bg-[#050505] pb-8 md:pb-12"
        >
            <div class="container mx-auto px-8">
                <div class="w-full mx-auto">
                    <div class="w-full">
                        <div class="mb-6">
                            <h2 class="font-serif text-3xl md:text-4xl font-medium text-zinc-100 mb-6">
                                {energy.number} {energy.title}
                            </h2>
                        </div>
                        <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-6">
                            {energy.content1}
                        </p>
                        <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-8">
                            {energy.content2}
                        </p>

                        <!-- Equation Section -->
                        <div class="mb-8 p-6 bg-[#0a0a0a] rounded-lg border border-[#f2e25d]/10">
                            <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-4">
                                {energy.equationIntro}
                            </p>
                            
                            <div class="flex justify-center my-6">
                                <div class="bg-[#f2e25d]/5 border border-[#f2e25d]/20 px-8 py-4 rounded">
                                    <span class="font-serif text-2xl md:text-3xl text-[#f2e25d] font-medium tracking-wide">
                                        <span set:html={equationHtml} />
                                    </span>
                                </div>
                            </div>
                        </div>

                        <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-12">
                            {energy.content3}
                        </p>
                    </div>

                    <!-- 7.2.1 Cooking Fuel -->
                    {cookingFuel && (
                        <div id="cooking-fuel" class="mb-16">
                            <div class="w-full mb-8">
                                <h3 class="font-serif text-2xl md:text-3xl font-medium text-zinc-100 mb-6">
                                    {cookingFuel.number} {cookingFuel.title}
                                </h3>
                                <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed whitespace-pre-line mb-8">
                                    {cookingFuel.content}
                                </p>
                            </div>

                            <!-- Table 66 -->
                            <div class="mb-10 w-full mx-auto">
                                <h5 class="font-serif text-xl md:text-2xl text-zinc-100 font-medium mb-4 text-center">
                                    {cookingFuel.tableTitle}
                                </h5>
                                <div class="overflow-x-auto">
                                    <table class="w-full border-collapse bg-[#0a0a0a] border border-[#f2e25d]/10 text-sm md:text-base">
                                        <thead>
                                            <tr class="bg-[#f2e25d]/5 border-b border-[#f2e25d]/20">
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-center font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "वडा" : "Ward"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "काठ/दाउरा" : "Wood"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "एल.पी. ग्याँस" : "LPG"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "विद्युत" : "Electricity"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "गुइँठा" : "Guitha"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "बायो ग्याँस" : "Biogas"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "मट्टितेल" : "Kerosene"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "अन्य" : "Others"}
                                                </th>
                                                <th class="px-2 py-3 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "जम्मा" : "Total"}
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {cookingFuel.tableData.map((row: any) => (
                                                <tr class="text-zinc-100 border-b border-[#f2e25d]/5 hover:bg-[#f2e25d]/5 transition-colors duration-200">
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center font-medium bg-[#f2e25d]/5">
                                                        {row.ward}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.wood}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.lpg}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.electricity}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.guitha}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.biogas}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.kerosene}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.others}
                                                    </td>
                                                    <td class="px-2 py-2 text-right font-bold bg-[#f2e25d]/5 text-[#f2e25d]">
                                                        {row.total}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <p class="text-zinc-400 text-sm text-right mt-2 font-serif italic mb-8">
                                    {lang === "ne" ? "स्रोत:" : "Source:"} {cookingFuel.source}
                                </p>
                            </div>

                            <!-- Pie Chart Container -->
                            <div class="w-full mb-10">
                                <h5 class="font-serif text-xl md:text-2xl text-zinc-100 font-medium mb-6 text-center">
                                    {cookingFuel.chartTitle}
                                </h5>
                                <div class="bg-[#0a0a0a] border border-[#f2e25d]/10 rounded-lg p-6 flex flex-col items-center">
                                    <div id="cooking-fuel-chart" class="w-full h-[400px]" data-chart-data={JSON.stringify(cookingFuel.chartData)}></div>
                                </div>
                            </div>
                           
                            <div class="w-full">
                                <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-6">
                                    {cookingFuel.content2}
                                </p>
                            </div>
                        </div>
                    )}

                    <!-- 7.2.2 Lighting Fuel -->
                    {lightingFuel && (
                        <div id="lighting-fuel" class="mb-16">
                            <div class="w-full mb-8">
                                <h3 class="font-serif text-2xl md:text-3xl font-medium text-zinc-100 mb-6">
                                    {lightingFuel.number} {lightingFuel.title}
                                </h3>
                                <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-8">
                                    {lightingFuel.content}
                                </p>
                            </div>

                            <!-- Table 67 -->
                            <div class="mb-10 w-full mx-auto">
                                <h5 class="font-serif text-xl md:text-2xl text-zinc-100 font-medium mb-4 text-center">
                                    {lightingFuel.tableTitle}
                                </h5>
                                <div class="overflow-x-auto">
                                    <table class="w-full border-collapse bg-[#0a0a0a] border border-[#f2e25d]/10 text-sm md:text-base">
                                        <thead>
                                            <tr class="bg-[#f2e25d]/5 border-b border-[#f2e25d]/20">
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-center font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "वडा" : "Ward"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "बिजुली" : "Electricity"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "सोलार" : "Solar"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "मट्टितेल" : "Kerosene"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "बायो ग्याँस" : "Biogas"}
                                                </th>
                                                <th class="px-2 py-3 border-r border-[#f2e25d]/10 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "अन्य" : "Others"}
                                                </th>
                                                <th class="px-2 py-3 text-right font-serif text-zinc-100 font-medium">
                                                    {lang === "ne" ? "जम्मा" : "Total"}
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {lightingFuel.tableData.map((row: any) => (
                                                <tr class="text-zinc-100 border-b border-[#f2e25d]/5 hover:bg-[#f2e25d]/5 transition-colors duration-200">
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center font-medium bg-[#f2e25d]/5">
                                                        {row.ward}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.electricity}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.solar}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.kerosene}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.biogas}
                                                    </td>
                                                    <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-right">
                                                        {row.others}
                                                    </td>
                                                    <td class="px-2 py-2 text-right font-bold bg-[#f2e25d]/5 text-[#f2e25d]">
                                                        {row.total}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <p class="text-zinc-400 text-sm text-right mt-2 font-serif italic mb-8">
                                    {lang === "ne" ? "स्रोत:" : "Source:"} {lightingFuel.source}
                                </p>
                            </div>
                            
                            <div class="w-full mb-10">
                                 <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-6">
                                    {lightingFuel.content2}
                                </p>
                            </div>

                            <!-- Bar Chart Container -->
                            <div class="w-full mb-10">
                                <h5 class="font-serif text-xl md:text-2xl text-zinc-100 font-medium mb-6 text-center">
                                    {lightingFuel.chartTitle}
                                </h5>
                                <div class="bg-[#0a0a0a] border border-[#f2e25d]/10 rounded-lg p-6 flex flex-col items-center">
                                    <div id="lighting-fuel-chart" class="w-full h-[400px]" data-chart-data={JSON.stringify(lightingFuel.chartData)}></div>
                                </div>
                            </div>
                        </div>
                    )}

                    <!-- 7.2.3 Alternative Energy -->
                    {alternativeEnergy && (
                        <div id="alternative-energy">
                            <div class="w-full">
                                <h3 class="font-serif text-2xl md:text-3xl font-medium text-zinc-100 mb-6">
                                    {alternativeEnergy.number} {alternativeEnergy.title}
                                </h3>
                                <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-6">
                                    {alternativeEnergy.content}
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </section>
    )
}

<script>
    import * as d3 from "d3";

    // Pie Chart Logic
    const initPieChart = () => {
        const container = document.getElementById("cooking-fuel-chart");
        if (!container) return;

        const dataStr = container.dataset.chartData;
        if (!dataStr) return;
        const data = JSON.parse(dataStr);

        container.innerHTML = "";
        const width = container.clientWidth;
        const height = container.clientHeight;
        const radius = Math.min(width, height) / 2;

        const svg = d3.select(container)
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        const pie = d3.pie<any>().value((d: any) => d.value);
        const arc = d3.arc<any>().innerRadius(0).outerRadius(radius * 0.8);
        const arcHover = d3.arc<any>().innerRadius(0).outerRadius(radius * 0.9);

        // Tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "absolute bg-black/90 border border-[#f2e25d]/30 text-white text-sm px-3 py-2 rounded pointer-events-none opacity-0 transition-opacity z-50");

        const paths = svg.selectAll("path")
            .data(pie(data))
            .enter()
            .append("path")
            .attr("d", arc)
            .attr("fill", (d: any) => d.data.color)
            .attr("stroke", "#0a0a0a")
            .attr("stroke-width", "2px")
            .style("cursor", "pointer")
            .transition()
            .duration(1000)
            .attrTween("d", function (d: any) {
                const i = d3.interpolate(d.startAngle + 0.1, d.endAngle);
                return function (t) {
                    d.endAngle = i(t);
                    return arc(d) as string;
                }
            });

        svg.selectAll("path")
            .on("mouseover", function (event, d: any) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("d", arcHover);
                
                tooltip.style("opacity", 1)
                    .html(`<div class="font-serif"><strong>${d.data.label}</strong><br/>${d.data.value}%</div>`);
            })
            .on("mousemove", function(event) {
                tooltip
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
            .on("mouseout", function () {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("d", arc);
                tooltip.style("opacity", 0);
            });
        
        // Legends
        const legendGroup = svg.append("g")
            .attr("transform", `translate(${radius + 20}, ${-height/4})`);
        
        // Check if legend fits, otherwise stack vertically or hide? 
        // For simplicity, let's keep it simple or remove if screen is small.
        // Actually screen width check inside JS is better.
        if (width > 600) {
            const legend = legendGroup.selectAll(".legend")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "legend")
                .attr("transform", (d: any, i: number) => `translate(0, ${i * 25})`);

            legend.append("rect")
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", (d: any) => d.color);

            legend.append("text")
                .attr("x", 24)
                .attr("y", 14)
                .text((d: any) => `${d.label} (${d.value}%)`)
                .style("font-size", "14px")
                .style("fill", "#e4e4e7")
                .attr("class", "font-serif");
        }
    };

    // Bar Chart Logic
    const initBarChart = () => {
        const container = document.getElementById("lighting-fuel-chart");
        if (!container) return;

        const dataStr = container.dataset.chartData;
        if (!dataStr) return;
        const data = JSON.parse(dataStr);

        container.innerHTML = "";
        const width = container.clientWidth;
        const height = container.clientHeight;
        const margin = { top: 20, right: 30, bottom: 60, left: 60 };
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = Math.max(height - margin.top - margin.bottom, 100);

        const svg = d3.select(container)
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // X Axis
        const x = d3.scaleBand()
            .range([0, chartWidth])
            .domain(data.map((d: any) => d.label))
            .padding(0.4);

        svg.append("g")
            .attr("transform", `translate(0,${chartHeight})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "12px")
            .style("fill", "#d4d4d8")
            .attr("class", "font-serif");

        // Y Axis
        const maxValue = d3.max(data, (d: any) => d.value as number) || 100;
        const y = d3.scaleLinear()
            .domain([0, maxValue])
            .range([chartHeight, 0]);

        svg.append("g")
            .call(d3.axisLeft(y))
            .selectAll("text")
            .style("fill", "#d4d4d8")
            .attr("class", "font-serif");
        
        svg.selectAll(".domain, line").style("stroke", "#52525b");

        // Bars
        svg.selectAll("mybar")
            .data(data)
            .enter()
            .append("rect")
            .attr("x", (d: any) => x(d.label) ?? 0)
            .attr("y", chartHeight)
            .attr("width", x.bandwidth())
            .attr("height", 0)
            .attr("fill", (d: any) => d.color)
            .transition()
            .duration(800)
            .attr("y", (d: any) => {
                const yVal = y(d.value);
                return yVal >= 0 ? yVal : chartHeight;
            })
            .attr("height", (d: any) => {
                const h = chartHeight - (y(d.value) ?? chartHeight);
                return h >= 0 ? h : 0;
            });
        
        // Labels on top of bars
        svg.selectAll(".text")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "label font-serif")
            .attr("x", (d: any) => ((x(d.label) ?? 0) + x.bandwidth() / 2))
            .attr("y", (d: any) => (y(d.value) ?? 0) - 5)
            .attr("text-anchor", "middle")
            .text((d: any) => d.value)
            .style("fill", "#e4e4e7")
            .style("opacity", 0)
            .transition()
            .delay(800)
            .duration(200)
            .style("opacity", 1);
    }

    // Initialize on load and on view transitions (Astro)
    document.addEventListener("astro:page-load", () => {
        initPieChart();
        initBarChart();
    });
    
    // Initial load support if ViewTransitions not widely used or configured
    initPieChart();
    initBarChart();
    
    // Resize observer to redraw on window resize
    const resizeObserver = new ResizeObserver(() => {
        // Debounce simple
        window.requestAnimationFrame(() => {
            initPieChart();
            initBarChart();
        });
    });
    
    const pContainer = document.getElementById("cooking-fuel-chart");
    const bContainer = document.getElementById("lighting-fuel-chart");
    
    if (pContainer) resizeObserver.observe(pContainer);
    if (bContainer) resizeObserver.observe(bContainer);

</script>
