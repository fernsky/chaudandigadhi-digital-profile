---
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";
import { formatNumber } from "../../../lib/i18n/formatters";
import type { Language } from "../../../lib/i18n";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

type CommunicationSection = {
    title: string;
    number: string;
    content: string;
    tableTitle: string;
    tableData: Array<{
        sn: string;
        name: string;
        address: string;
    }>;
    source: string;
};

type ModernAmenitiesSection = {
    title: string;
    number: string;
    content: string;
    tableTitle: string;
    tableData: Array<{
        amenity: string;
        w1: string;
        w2: string;
        w3: string;
        w4: string;
        w5: string;
        w6: string;
        w7: string;
        w8: string;
        w9: string;
        w10: string;
        total: string;
    }>;
    source: string;
    chartTitle: string;
    chartData: Array<{ label: string; value: number }>;
};

const communication = (await loadChapterSection(
    7,
    "communication",
    lang
)) as CommunicationSection;

const modernAmenities = (await loadChapterSection(
    7,
    "modern-amenities",
    lang
)) as ModernAmenitiesSection;
---

<!-- 7.3 Communication and Technology -->{
    communication && (
        <section id="communication" class="relative bg-[#050505] pb-8 md:pb-12">
            <div class="container mx-auto px-8">
                <div class="w-full">
                    <div class="mb-6">
                        <h2 class="font-serif text-3xl md:text-4xl font-medium text-zinc-100 mb-6">
                            {formatNumber(communication.number, lang)} {communication.title}
                        </h2>
                        <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed mb-6">
                            {communication.content}
                        </p>
                    </div>

                    <!-- Table 68 -->
                    <div class="mb-10">
                        <h5 class="font-serif text-xl md:text-2xl text-zinc-100 font-medium mb-4 text-center">
                            {communication.tableTitle}
                        </h5>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse bg-[#0a0a0a] border border-[#f2e25d]/10 text-sm md:text-base">
                                <thead>
                                    <tr class="bg-[#f2e25d]/5 border-b border-[#f2e25d]/20">
                                        <th class="px-3 py-3 border-r border-[#f2e25d]/10 text-center w-16 font-serif text-zinc-100 font-medium">
                                            {lang === "ne" ? "क्र.सं." : "SN"}
                                        </th>
                                        <th class="px-3 py-3 border-r border-[#f2e25d]/10 text-left font-serif text-zinc-100 font-medium">
                                            {lang === "ne" ? "सञ्चारको नाम" : "Communication Name"}
                                        </th>
                                        <th class="px-3 py-3 text-left font-serif text-zinc-100 font-medium">
                                            {lang === "ne" ? "ठेगाना" : "Address"}
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {communication.tableData.map((row: any) => (
                                        <tr class="text-zinc-100 border-b border-[#f2e25d]/5 hover:bg-[#f2e25d]/5 transition-colors duration-200">
                                            <td class="px-3 py-2 border-r border-[#f2e25d]/5 text-center font-medium">
                                                {formatNumber(row.sn, lang)}
                                            </td>
                                            <td class="px-3 py-2 border-r border-[#f2e25d]/5">
                                                {row.name}
                                            </td>
                                            <td class="px-3 py-2">
                                                {row.address}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <p class="text-zinc-400 text-sm text-right mt-2 font-serif italic">
                            {lang === "ne" ? "स्रोत:" : "Source:"} {communication.source}
                        </p>
                    </div>
                </div>
            </div>
        </section>
    )
}

<!-- 7.3.1 Modern Amenities -->{
    modernAmenities && (
        <section
            id="modern-amenities"
            class="relative bg-[#050505] pb-8 md:pb-12"
        >
            <div class="container mx-auto px-8">
                <div class="w-full mx-auto">
                    <div class="w-full">
                        <div class="mb-6">
                            <h3 class="font-serif text-2xl md:text-3xl font-medium text-zinc-100 mb-6">
                                {formatNumber(modernAmenities.number, lang)} {modernAmenities.title}
                            </h3>
                        </div>
                    </div>

                    <!-- Table 69 -->
                    <div class="mb-10">
                        <h5 class="font-serif text-xl md:text-2xl text-zinc-100 font-medium mb-4 text-center">
                            {modernAmenities.tableTitle}
                        </h5>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse bg-[#0a0a0a] border border-[#f2e25d]/10 text-xs md:text-sm">
                                <thead>
                                    <tr class="bg-[#f2e25d]/5 border-b border-[#f2e25d]/20">
                                        <th
                                            rowspan="2"
                                            class="px-2 py-3 border-r border-[#f2e25d]/10 text-left font-serif text-zinc-100 font-medium min-w-[200px]"
                                        >
                                            {lang === "ne" ? "विवरण" : "Description"}
                                        </th>
                                        <th
                                            colspan="10"
                                            class="px-2 py-2 border-r border-[#f2e25d]/10 text-center font-serif text-zinc-100 font-medium border-b border-[#f2e25d]/10"
                                        >
                                            {lang === "ne" ? "वडा नं." : "Ward No."}
                                        </th>
                                        <th
                                            rowspan="2"
                                            class="px-2 py-3 text-center font-serif text-zinc-100 font-medium"
                                        >
                                            {lang === "ne" ? "जम्मा" : "Total"}
                                        </th>
                                    </tr>
                                    <tr class="bg-[#f2e25d]/5 border-b border-[#f2e25d]/20">
                                        {Array.from({ length: 10 }, (_, i) => (
                                            <th class="px-2 py-2 border-r border-[#f2e25d]/10 text-center font-serif text-zinc-100 font-medium">
                                                {formatNumber(i + 1, lang)}
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {modernAmenities.tableData.map((row: any) => (
                                        <tr class="text-zinc-100 border-b border-[#f2e25d]/5 hover:bg-[#f2e25d]/5 transition-colors duration-200">
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 font-medium">
                                                {row.amenity}
                                            </td>
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.w1, lang)}
                                            </td>
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.w2, lang)}
                                            </td>
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.w3, lang)}
                                            </td>
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.w4, lang)}
                                            </td>
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.w5, lang)}
                                            </td>
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.w6, lang)}
                                            </td>
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.w7, lang)}
                                            </td>
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.w8, lang)}
                                            </td>
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.w9, lang)}
                                            </td>
                                            <td class="px-2 py-2 border-r border-[#f2e25d]/5 text-center">
                                                {formatNumber(row.w10, lang)}
                                            </td>
                                            <td class="px-2 py-2 text-center font-bold text-[#f2e25d]">
                                                {formatNumber(row.total, lang)}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <p class="text-zinc-400 text-sm text-right mt-2 font-serif italic mb-8">
                            {lang === "ne" ? "स्रोत:" : "Source:"} {modernAmenities.source}
                        </p>
                    </div>

                    <div class="w-full mb-10">
                        <p class="text-zinc-100 font-serif text-lg md:text-xl font-light leading-relaxed whitespace-pre-line mb-8">
                            {modernAmenities.content}
                        </p>

                         <!-- Bar Chart Container -->
                         <div class="mb-10">
                            <h5 class="font-serif text-xl md:text-2xl text-zinc-100 font-medium mb-6 text-center">
                                {modernAmenities.chartTitle}
                            </h5>
                            <div class="bg-[#0a0a0a] border border-[#f2e25d]/10 rounded-lg p-4 md:p-6 flex flex-col items-center overflow-x-auto">
                                <div id="amenities-chart" class="w-full min-w-[600px] h-[500px]" data-chart-data={JSON.stringify(modernAmenities.chartData)}></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </section>
    )
}

<script>
    import * as d3 from "d3";

    const initAmenitiesChart = () => {
        const container = document.getElementById("amenities-chart");
        if (!container) return;

        const dataStr = container.dataset.chartData;
        if (!dataStr) return;
        const data = JSON.parse(dataStr);

        container.innerHTML = "";
        const width = container.clientWidth;
        const height = container.clientHeight;
        const margin = { top: 20, right: 30, bottom: 120, left: 60 }; // Increased bottom margin for labels
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = Math.max(height - margin.top - margin.bottom, 100);

        const lang = document.documentElement.lang || "ne";
        const formatValue = (val: number | string) => {
            if (lang === "en") return val.toString();
            const nepalDigits: { [key: string]: string } = {
                "0": "०", "1": "१", "2": "२", "3": "३", "4": "४",
                "5": "५", "6": "६", "7": "७", "8": "८", "9": "९", ".": "."
            };
            return val.toString().split("").map(d => nepalDigits[d] || d).join("");
        };

        const svg = d3.select(container)
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Tooltip
        const tooltipId = "amenities-tooltip";
        let tooltip = d3.select(`#${tooltipId}`);
        if (tooltip.empty()) {
            tooltip = d3.select("body").append("div")
                .attr("id", tooltipId)
                .attr("class", "fixed bg-black/90 border border-[#f2e25d]/30 text-white text-sm px-3 py-2 rounded pointer-events-none opacity-0 transition-opacity z-50");
        }

        // X Axis
        const x = d3.scaleBand()
            .range([0, chartWidth])
            .domain(data.map((d:any) => d.label))
            .padding(0.4);

        svg.append("g")
            .attr("transform", `translate(0,${chartHeight})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "12px")
            .style("fill", "#d4d4d8")
            .attr("class", "font-serif");

        // Y Axis
        const maxValue = d3.max(data, (d: any) => d.value as number) || 100;
        const y = d3.scaleLinear()
            .domain([0, maxValue])
            .range([chartHeight, 0]);

        svg.append("g")
            .call(d3.axisLeft(y).tickFormat((d: any) => formatValue(d)))
            .selectAll("text")
            .style("fill", "#d4d4d8")
            .attr("class", "font-serif");
        
        svg.selectAll(".domain, line").style("stroke", "#52525b");

        // Bars
        svg.selectAll("mybar")
            .data(data)
            .enter()
            .append("rect")
            .attr("x", (d: any) => x(d.label) ?? 0)
            .attr("y", chartHeight)
            .attr("width", x.bandwidth())
            .attr("height", 0)
            .attr("fill", "#86efac")
            .style("cursor", "pointer")
            .on("mouseover", function (event, d: any) {
                d3.select(this).attr("fill", "#4ade80");
                tooltip.style("opacity", 1)
                    .html(`<div class="font-serif"><strong>${d.label}</strong><br/>${formatValue(d.value)}</div>`);
            })
            .on("mousemove", function(event) {
                tooltip
                    .style("left", (event.clientX + 10) + "px")
                    .style("top", (event.clientY - 10) + "px");
            })
            .on("mouseout", function () {
                d3.select(this).attr("fill", "#86efac");
                tooltip.style("opacity", 0);
            })
            .transition()
            .duration(800)
            .attr("y", (d: any) => {
                const yVal = y(d.value);
                return yVal >= 0 ? yVal : chartHeight;
            })
            .attr("height", (d: any) => {
                const h = chartHeight - (y(d.value) ?? chartHeight);
                return h >= 0 ? h : 0;
            });
        
        // Labels on top of bars not needed as per screenshot style, but good for accessibility. 
        // Screenshot doesn't show values on top, but scales are readable. Keeping it clean.
    }

    document.addEventListener("astro:page-load", () => {
        initAmenitiesChart();
    });
    
    initAmenitiesChart();

    const resizeObserver = new ResizeObserver(() => {
        window.requestAnimationFrame(() => {
             initAmenitiesChart();
        });
    });
    
    const container = document.getElementById("amenities-chart");
    if (container) resizeObserver.observe(container);

</script>
