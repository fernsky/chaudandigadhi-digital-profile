---
interface Props {
    data: {
        private: number;
        rented: number;
        institutional: number;
        other: number;
    };
}

const { data } = Astro.props;

const chartData = [
    { label: "निजी", value: data.private },
    { label: "भाडामा", value: data.rented },
    { label: "संस्थागत", value: data.institutional },
    { label: "अन्य", value: data.other },
].filter((d) => d.value > 0);
---

<div class="w-full h-[350px] md:h-[400px]" id="housing-ownership-chart"></div>

<div
    id="ho-chart-data-store"
    data-chart={JSON.stringify(chartData)}
    class="hidden"
>
</div>

<script>
    import * as d3 from "d3";

    // @ts-ignore
    const container = document.getElementById("housing-ownership-chart");
    // @ts-ignore
    const dataStore = document.getElementById("ho-chart-data-store");

    if (container && dataStore) {
        const data = JSON.parse(dataStore.dataset.chart || "[]");

        const margin = { top: 20, right: 20, bottom: 20, left: 20 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = container.clientHeight - margin.top - margin.bottom;
        const radius = Math.min(width, height) / 2;

        container.innerHTML = "";

        const svg = d3
            .select(container)
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        const color = d3
            .scaleOrdinal()
            .domain(data.map((d: any) => d.label))
            .range(["#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6"]);

        const pie = d3
            .pie()
            .value((d: any) => d.value)
            .sort(null);

        const arc = d3
            .arc()
            .innerRadius(radius * 0.5) // Doughnut
            .outerRadius(radius * 0.8);

        const outerArc = d3
            .arc()
            .innerRadius(radius * 0.9)
            .outerRadius(radius * 0.9);

        // @ts-ignore
        svg.selectAll("allSlices")
            .data(pie(data))
            .join("path")
            .attr("d", arc as any)
            .attr("fill", (d: any) => color(d.data.label) as string)
            .attr("stroke", "#18181b") // zinc-950
            .style("stroke-width", "2px")
            .style("opacity", 0.9)
            .on("mouseover", function () {
                d3.select(this).style("opacity", 1);
            })
            .on("mouseout", function () {
                d3.select(this).style("opacity", 0.9);
            });

        // Legend
        const legend = svg
            .append("g")
            .attr(
                "transform",
                `translate(${radius + 20}, ${-height / 2 + 20})`,
            );

        // Adjust legend position if screen is small
        if (width < 500) {
            // Position below chart?
        }

        // Simple Centered Labels for Doughnut? Or External Legend?
        // Let's do a simple legend in the corner or separate div.
        // Actually, let's use a separate HTML legend for better responsiveness.
    }
</script>

<!-- Custom HTML Legend -->
<div class="flex flex-wrap justify-center gap-4 mt-4">
    {
        chartData.map((d, i) => (
            <div class="flex items-center space-x-2">
                <div
                    class="w-3 h-3 rounded-full"
                    style={`background-color: ${["#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6"][i % 5]}`}
                />
                <span class="text-zinc-300 text-sm font-serif">
                    {d.label} ({d.value.toLocaleString()})
                </span>
            </div>
        ))
    }
</div>
