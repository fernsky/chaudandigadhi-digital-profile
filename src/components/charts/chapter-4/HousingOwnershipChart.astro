---
interface Props {
    data: {
        ward: number;
        private: number;
        rented: number;
        institutional: number;
        other: number;
        total: number;
    }[];
}

const { data } = Astro.props;

// Aggregate data
const totals = data.reduce(
    (acc, curr) => ({
        private: acc.private + curr.private,
        rented: acc.rented + curr.rented,
        institutional: acc.institutional + curr.institutional,
        other: acc.other + curr.other,
    }),
    { private: 0, rented: 0, institutional: 0, other: 0 },
);

const chartData = [
    { label: "निजी", value: totals.private, color: "#10b981" }, // emerald-500
    { label: "भाडामा", value: totals.rented, color: "#3b82f6" }, // blue-500
    { label: "संस्थागत", value: totals.institutional, color: "#8b5cf6" }, // violet-500
    { label: "अन्य", value: totals.other, color: "#6b7280" }, // gray-500
];

const totalHouses = Object.values(totals).reduce((a, b) => a + b, 0);
---

<div
    class="relative w-full h-[400px] bg-zinc-900/50 rounded-xl border border-zinc-800 p-6 backdrop-blur-sm flex flex-col items-center justify-center"
>
    <div class="absolute top-4 left-6">
        <h3 class="text-lg font-serif text-white">घरको स्वामित्व</h3>
        <p class="text-sm text-zinc-400">
            कुल घरधुरी: {totalHouses.toLocaleString("ne-NP")}
        </p>
    </div>

    <div class="relative w-64 h-64 mt-8">
        <svg
            id="housing-ownership-chart"
            viewBox="0 0 100 100"
            class="w-full h-full transform -rotate-90"></svg>

        <!-- Center Text -->
        <div
            class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"
        >
            <span class="text-3xl font-bold text-white font-serif"
                >{((totals.private / totalHouses) * 100).toFixed(1)}%</span
            >
            <span class="text-xs text-emerald-400">निजी</span>
        </div>
    </div>

    <div class="mt-6 flex flex-wrap gap-4 justify-center">
        {
            chartData.map((item) => (
                <div class="flex items-center gap-2">
                    <div
                        class="w-3 h-3 rounded-full"
                        style={`background-color: ${item.color}`}
                    />
                    <div class="text-sm text-zinc-300">
                        <span class="font-medium">{item.label}</span>
                        <span class="text-zinc-500 ml-1">
                            ({item.value.toLocaleString("ne-NP")})
                        </span>
                    </div>
                </div>
            ))
        }
    </div>
</div>

<script is:inline define:vars={{ initialData: chartData, total: totalHouses }}>
    const svg = document.getElementById("housing-ownership-chart");

    if (svg) {
        let cumulativePercent = 0;

        initialData.forEach((item) => {
            const percent = item.value / total;
            const startX = Math.cos(2 * Math.PI * cumulativePercent);
            const startY = Math.sin(2 * Math.PI * cumulativePercent);

            cumulativePercent += percent;

            const endX = Math.cos(2 * Math.PI * cumulativePercent);
            const endY = Math.sin(2 * Math.PI * cumulativePercent);

            const largeArcFlag = percent > 0.5 ? 1 : 0;

            const pathData = [
                `M 0 0`, // Move to center (for pie) or specific radius for donut?
                // Actually for donut we calculate inner/outer points.
                // Let's use simple stroke-dasharray technique for donut circles which is easier and smoother animation.
            ];
        });

        // Re-impl using stroke-dasharray for perfect circles
        svg.innerHTML = "";

        const radius = 40;
        const circumference = 2 * Math.PI * radius;
        let offset = 0; // Start at top (due to rotate-90 in CSS)

        initialData.forEach((item) => {
            const percent = item.value / total;
            const strokeDasharray = `${percent * circumference} ${circumference}`;

            const circle = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "circle",
            );
            circle.setAttribute("cx", "50");
            circle.setAttribute("cy", "50");
            circle.setAttribute("r", radius.toString());
            circle.setAttribute("fill", "transparent");
            circle.setAttribute("stroke", item.color);
            circle.setAttribute("stroke-width", "10");
            circle.setAttribute("stroke-dasharray", strokeDasharray);
            circle.setAttribute("stroke-dashoffset", (-offset).toString());

            // Tooltip
            const title = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "title",
            );
            title.textContent = `${item.label}: ${item.value.toLocaleString()} (${(percent * 100).toFixed(1)}%)`;
            circle.appendChild(title);

            svg.appendChild(circle);

            offset += percent * circumference;
        });
    }
</script>
