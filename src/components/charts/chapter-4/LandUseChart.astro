---
interface Props {
    data: Array<{
        sector: string;
        area: number;
    }>;
}

const { data } = Astro.props;

// Sort by area descending
const chartData = [...data]
    .sort((a, b) => b.area - a.area)
    .map((d) => ({ label: d.sector, value: d.area }));
---

<div class="w-full h-[350px] md:h-[400px]" id="land-use-chart"></div>

<div
    id="lu-chart-data-store"
    data-chart={JSON.stringify(chartData)}
    class="hidden"
>
</div>

<script>
    import * as d3 from "d3";

    // @ts-ignore
    const container = document.getElementById("land-use-chart");
    // @ts-ignore
    const dataStore = document.getElementById("lu-chart-data-store");

    if (container && dataStore) {
        const data = JSON.parse(dataStore.dataset.chart || "[]");

        const margin = { top: 20, right: 20, bottom: 20, left: 20 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = container.clientHeight - margin.top - margin.bottom;
        const radius = Math.min(width, height) / 2;

        container.innerHTML = "";

        const svg = d3
            .select(container)
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        const color = d3
            .scaleOrdinal()
            .domain(data.map((d: any) => d.label))
            .range([
                "#16a34a",
                "#84cc16",
                "#eab308",
                "#f97316",
                "#ef4444",
                "#a855f7",
                "#06b6d4",
                "#64748b",
            ]);

        const pie = d3
            .pie()
            .value((d: any) => d.value)
            .sort(null);

        const arc = d3
            .arc()
            .innerRadius(radius * 0.5) // Doughnut
            .outerRadius(radius * 0.8);

        // @ts-ignore
        svg.selectAll("allSlices")
            .data(pie(data))
            .join("path")
            .attr("d", arc as any)
            .attr("fill", (d: any) => color(d.data.label) as string)
            .attr("stroke", "#18181b") // zinc-950
            .style("stroke-width", "2px")
            .style("opacity", 0.9)
            .on("mouseover", function () {
                d3.select(this).style("opacity", 1);
            })
            .on("mouseout", function () {
                d3.select(this).style("opacity", 0.9);
            });
    }
</script>

<!-- Custom HTML Legend -->
<div class="flex flex-wrap justify-center gap-4 mt-8">
    {
        chartData.map((d, i) => (
            <div class="flex items-center space-x-2">
                <div
                    class="w-3 h-3 rounded-full"
                    style={`background-color: ${["#16a34a", "#84cc16", "#eab308", "#f97316", "#ef4444", "#a855f7", "#06b6d4", "#64748b"][i % 8]}`}
                />
                <span class="text-zinc-300 text-sm font-serif">
                    {d.label} ({d.value.toLocaleString()} हे.)
                </span>
            </div>
        ))
    }
</div>
