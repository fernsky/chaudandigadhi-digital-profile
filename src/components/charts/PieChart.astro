---
import type { Language } from "../../lib/i18n";

interface Props {
    id: string;
    title: string;
    labels: string[];
    data: number[];
    backgroundColor?: string[];
    lang: Language;
    type?: "pie" | "doughnut";
}

const {
    id,
    title,
    labels,
    data,
    backgroundColor = [
        "rgba(100, 116, 139, 0.8)",
        "rgba(71, 85, 105, 0.8)",
        "rgba(148, 163, 184, 0.8)",
        "rgba(51, 65, 85, 0.8)",
        "rgba(30, 41, 59, 0.8)",
    ],
    lang,
    type = "pie",
} = Astro.props;

const chartData = {
    labels,
    datasets: [
        {
            data,
            backgroundColor,
            borderWidth: 2,
            borderColor: "#1e293b",
            hoverOffset: 4,
        },
    ],
};

const chartConfig = {
    type: type,
    data: chartData,
    options: {
        responsive: true,
        maintainAspectRatio: true,
        cutout: type === "doughnut" ? "50%" : undefined,
        plugins: {
            legend: {
                position: "bottom",
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    pointStyle: "circle",
                    font: {
                        size: 12,
                        family:
                            lang === "ne"
                                ? "'Noto Sans Devanagari', sans-serif"
                                : "'Inter', sans-serif",
                    },
                    color: "#cbd5e1",
                },
            },
            title: {
                display: true,
                text: title,
                font: {
                    size: 16,
                    weight: "bold",
                    family:
                        lang === "ne"
                            ? "'Noto Sans Devanagari', sans-serif"
                            : "'Inter', sans-serif",
                },
                color: "#e2e8f0",
                padding: {
                    bottom: 20,
                },
            },
        },
    },
};
---

<div class="chart-container my-8">
    <canvas id={id} class="max-w-full"></canvas>
</div>

<script is:inline define:vars={{ id, chartConfig }}>
    // Load Chart.js from CDN if not already loaded
    if (typeof Chart === "undefined") {
        const script = document.createElement("script");
        script.src =
            "https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js";
        script.onload = () => initChart();
        document.head.appendChild(script);
    } else {
        initChart();
    }

    function initChart() {
        const ctx = document.getElementById(id);
        if (ctx && typeof Chart !== "undefined") {
            // Destroy existing chart if it exists to prevent overlap/errors on re-renders
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            // Define tooltip callback on client side to avoid serialization issues
            if (!chartConfig.options.plugins.tooltip) {
                chartConfig.options.plugins.tooltip = {};
            }

            chartConfig.options.plugins.tooltip.callbacks = {
                label: function (context) {
                    const label = context.label || "";
                    const value = context.raw || 0;
                    let total = 0;
                    const dataset = context.chart.data.datasets[0];
                    if (dataset && Array.isArray(dataset.data)) {
                        total = dataset.data.reduce(
                            (a, b) => Number(a) + Number(b),
                            0,
                        );
                    }

                    const percentage =
                        total > 0
                            ? ((Number(value) / total) * 100).toFixed(2)
                            : "0.00";
                    return `${label}: ${percentage}%`;
                },
            };

            new Chart(ctx, chartConfig);
        }
    }
</script>

<style>
    .chart-container {
        position: relative;
        background: transparent;
        padding: 1.5rem;
        box-shadow: none;
    }
</style>
