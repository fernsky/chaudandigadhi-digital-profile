---
import type { Language } from "../../../lib/i18n";
import { formatNumber } from "../../../lib/i18n/formatters";

interface Props {
    lang: Language;
    data?: {
        vaccine: string;
        coverage: number;
    }[];
}

const { lang, data } = Astro.props;

// Vaccination coverage data (fallback)
const vaccinationData = data || [
    { vaccine: "Quota2", coverage: 72.33 },
    { vaccine: "DPT-HepB-Hib3", coverage: 73.49 },
    { vaccine: "DPT-HepB-Hib1", coverage: 74.77 },
];
---

<div
    id="vaccination-chart"
    class="bg-[#0a0a0a] border border-[#f2e25d]/10 p-6 md:p-8"
>
    <h4 class="font-serif text-xl text-zinc-100 font-medium mb-6 text-center">
        {lang === "ne" ? "खोप कभरेज दर (%)" : "Vaccination Coverage Rate (%)"}
    </h4>

    <div class="space-y-4">
        {
            vaccinationData.map((item) => (
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-zinc-100 font-serif text-sm">
                            {item.vaccine}
                        </span>
                        <span class="text-[#f2e25d] font-bold text-lg">
                            {formatNumber(item.coverage, lang)}%
                        </span>
                    </div>
                    <div class="bg-[#050505] h-6 relative border border-[#f2e25d]/10 overflow-hidden">
                        <div
                            class="absolute inset-y-0 left-0 bg-gradient-to-r from-[#f2e25d] to-[#d4c74f] transition-all duration-700"
                            data-width={`${item.coverage}%`}
                            style={`width: ${item.coverage}%`}
                        />
                    </div>
                </div>
            ))
        }
    </div>

    <div class="mt-6 pt-6 border-t border-[#f2e25d]/10 text-center">
        <p class="text-zinc-400 font-serif text-xs italic">
            {lang === "ne" ? "स्रोत" : "Source"}: {
                lang === "ne"
                    ? "नगर कार्यपालिकाको कार्यालय (श्रावण २०८१/ असार ८२)"
                    : "Municipal Executive Office (July 2024 / June 2025)"
            }
        </p>
    </div>
</div>

<script is:inline src="https://d3js.org/d3.v7.min.js"></script>
<script is:inline>
    function initVaccinationAnimations() {
        const bars = document.querySelectorAll(
            "#vaccination-chart [data-width]",
        );
        if (bars.length === 0) return;

        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const bar = entry.target;
                        const width = bar.getAttribute("data-width");
                        if (typeof d3 !== "undefined") {
                            d3.select(bar)
                                .transition()
                                .duration(1000)
                                .ease(d3.easeCubicOut)
                                .style("width", width);
                        } else {
                            bar.style.width = width;
                        }
                    }
                });
            },
            { threshold: 0.2 },
        );

        bars.forEach((bar) => {
            bar.style.width = "0%";
            observer.observe(bar);
        });
    }

    if (document.readyState === "complete") {
        initVaccinationAnimations();
    } else {
        window.addEventListener("load", initVaccinationAnimations);
    }
    document.addEventListener("astro:page-load", initVaccinationAnimations);
</script>
