---
import type { Language } from "../../../lib/i18n";
import { formatNumber } from "../../../lib/i18n/formatters";

interface Props {
    lang: Language;
    data?: {
        type: string;
        percent: number;
        color: string;
    }[];
}

const { lang, data } = Astro.props;

// Toilet coverage data (fallback)
const toiletData = data || [
    {
        type: lang === "ne" ? "खाल्डे चर्पी" : "Pit toilet",
        percent: 64.87,
        color: "#f2e25d",
    },
    {
        type: lang === "ne" ? "फ्लस (सेप्टिक ट्याङ्क)" : "Flush (septic tank)",
        percent: 29.04,
        color: "#a3a3a3",
    },
    {
        type: lang === "ne" ? "फ्लस (सार्वजनिक ढल)" : "Flush (public sewer)",
        percent: 2.83,
        color: "#737373",
    },
    {
        type: lang === "ne" ? "चर्पी नभएको" : "No toilet",
        percent: 2.72,
        color: "#dc2626",
    },
    {
        type: lang === "ne" ? "सामुदायिक चर्पी" : "Community toilet",
        percent: 0.54,
        color: "#525252",
    },
];

let currentAngle = 0;

// Calculate total coverage (excluding "no toilet" or just sum of positive types?)
// Assuming "no toilet" is explicitly labeled "चर्पी नभएको" or similar.
// For now, let's sum everything except explicitly negative ones if we want "coverage".
// Or just sum everything? The text says "97.28% coverage" which refers to those having toilets.
const noToiletKeywords = ["चर्पी नभएको", "no toilet", "none"];
const totalCoverage = toiletData
    .filter((d) => !noToiletKeywords.some((k) => d.type.includes(k)))
    .reduce((acc, curr) => acc + curr.percent, 0);
---

<div class="bg-[#0a0a0a] border border-[#f2e25d]/10 p-6 md:p-8">
    <h4 class="font-serif text-xl text-zinc-100 font-medium mb-6 text-center">
        {lang === "ne" ? "शौचालय कभरेज" : "Toilet Coverage"}
    </h4>

    <div class="flex flex-col md:flex-row items-center justify-center gap-8">
        <!-- Donut Chart -->
        <svg viewBox="0 0 200 200" class="w-64 h-64">
            {
                toiletData.map((item) => {
                    const angle = (item.percent / 100) * 360;
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + angle;

                    const startRad = (startAngle - 90) * (Math.PI / 180);
                    const endRad = (endAngle - 90) * (Math.PI / 180);

                    const outerRadius = 80;
                    const innerRadius = 50;

                    const x1 = 100 + outerRadius * Math.cos(startRad);
                    const y1 = 100 + outerRadius * Math.sin(startRad);
                    const x2 = 100 + outerRadius * Math.cos(endRad);
                    const y2 = 100 + outerRadius * Math.sin(endRad);

                    const x3 = 100 + innerRadius * Math.cos(endRad);
                    const y3 = 100 + innerRadius * Math.sin(endRad);
                    const x4 = 100 + innerRadius * Math.cos(startRad);
                    const y4 = 100 + innerRadius * Math.sin(startRad);

                    const largeArc = angle > 180 ? 1 : 0;

                    const path = `M ${x1} ${y1} A ${outerRadius} ${outerRadius} 0 ${largeArc} 1 ${x2} ${y2} L ${x3} ${y3} A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${x4} ${y4} Z`;

                    currentAngle = endAngle;

                    return (
                        <path
                            d={path}
                            fill={item.color}
                            stroke="#050505"
                            stroke-width="2"
                            class="transition-all hover:opacity-80"
                        />
                    );
                })
            }
            <!-- Center text -->
            <text
                x="100"
                y="95"
                text-anchor="middle"
                class="fill-zinc-100 font-serif text-xl font-bold"
            >
                {formatNumber(totalCoverage.toFixed(2), lang)}%
            </text>
            <text
                x="100"
                y="110"
                text-anchor="middle"
                class="fill-zinc-400 font-serif text-xs"
            >
                {lang === "ne" ? "कभरेज" : "Coverage"}
            </text>
        </svg>

        <!-- Legend -->
        <div class="space-y-2">
            {
                toiletData.map((item) => (
                    <div class="flex items-center gap-3">
                        <div
                            class="w-4 h-4 rounded-sm"
                            style={`background-color: ${item.color}`}
                        />
                        <div class="flex-1">
                            <div class="text-zinc-100 font-serif text-xs">
                                {item.type}
                            </div>
                            <div class="text-zinc-400 font-serif text-xs">
                                {formatNumber(item.percent, lang)}%
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>
    </div>
</div>
