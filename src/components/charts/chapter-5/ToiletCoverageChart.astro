---
import type { Language } from "../../../lib/i18n";
import D3PieChart from "../D3PieChart.astro";
import { formatNumber } from "../../../lib/i18n/formatters";

interface Props {
    lang: Language;
    data?: {
        type: string;
        percent: number;
        color: string;
    }[];
}

const { lang, data } = Astro.props;

// Toilet coverage data (fallback)
const toiletData = data || [
    {
        type: lang === "ne" ? "खाल्डे चर्पी" : "Pit toilet",
        percent: 64.87,
        color: "#f2e25d",
    },
    {
        type: lang === "ne" ? "फ्लस (सेप्टिक ट्याङ्क)" : "Flush (septic tank)",
        percent: 29.04,
        color: "#a3a3a3",
    },
    {
        type: lang === "ne" ? "फ्लस (सार्वजनिक ढल)" : "Flush (public sewer)",
        percent: 2.83,
        color: "#737373",
    },
    {
        type: lang === "ne" ? "चर्पी नभएको" : "No toilet",
        percent: 2.72,
        color: "#dc2626",
    },
    {
        type: lang === "ne" ? "सामुदायिक चर्पी" : "Community toilet",
        percent: 0.54,
        color: "#525252",
    },
];

let currentAngle = 0;

// Calculate total coverage (excluding "no toilet" or just sum of positive types?)
// Assuming "no toilet" is explicitly labeled "चर्पी नभएको" or similar.
// For now, let's sum everything except explicitly negative ones if we want "coverage".
// Or just sum everything? The text says "97.28% coverage" which refers to those having toilets.
const noToiletKeywords = ["चर्पी नभएको", "no toilet", "none"];
const totalCoverage = toiletData
    .filter(
        (d) => !noToiletKeywords.some((k) => d.type.toLowerCase().includes(k)),
    )
    .reduce((acc, curr) => acc + curr.percent, 0);

const centerText = `${formatNumber(totalCoverage.toFixed(2), lang)}%`;
const centerLabel = lang === "ne" ? "कभरेज" : "Coverage";
---

<div class="space-y-6">
    <D3PieChart
        id="toilet-coverage-chart"
        title={lang === "ne" ? "शौचालय कभरेज" : "Toilet Coverage"}
        labels={toiletData.map((d) => d.type)}
        data={toiletData.map((d) => d.percent)}
        lang={lang}
        height={350}
        colors={toiletData.map((d) => d.color)}
        centerText={centerText}
        centerLabel={centerLabel}
    />
</div>
