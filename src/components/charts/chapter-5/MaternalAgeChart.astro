---
import type { Language } from "../../../lib/i18n";
import { formatNumber } from "../../../lib/i18n/formatters";

interface Props {
    lang: Language;
    data?: {
        range: string;
        count: number;
        percent: number;
    }[];
}

const { lang, data } = Astro.props;

// Default data (fallback)
const ageGroups = data || [
    { range: "15-19", count: 411, percent: 3.67 },
    { range: "20-24", count: 1610, percent: 14.4 },
    { range: "25-29", count: 2112, percent: 18.88 },
];

const maxPercent = Math.max(...ageGroups.map((g) => g.percent));
---

<div
    id="maternal-age-chart"
    class="bg-[#0a0a0a] border border-[#f2e25d]/10 p-6 md:p-8"
>
    <h4 class="font-serif text-xl text-zinc-100 font-medium mb-6 text-center">
        {
            lang === "ne"
                ? "पहिलो बच्चा जन्मदिँदा महिलाको उमेर"
                : "Age of woman at first birth"
        }
    </h4>

    <div class="space-y-4">
        {
            ageGroups.map((group) => (
                <div class="space-y-1">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-zinc-100 font-serif">
                            {formatNumber(group.range, lang)}{" "}
                            {lang === "ne" ? "वर्ष" : "Years"}
                        </span>
                        <div class="flex gap-4">
                            <span class="text-zinc-400 font-serif">
                                {formatNumber(group.count, lang)}{" "}
                                {lang === "ne" ? "जना" : "People"}
                            </span>
                            <span class="text-[#f2e25d] font-bold">
                                {formatNumber(group.percent, lang)}%
                            </span>
                        </div>
                    </div>
                    <div class="bg-[#050505] h-6 relative border border-[#f2e25d]/10 w-full">
                        <div
                            class="absolute inset-y-0 left-0 bg-[#f2e25d] transition-all duration-500"
                            data-width={`${(group.percent / maxPercent) * 100}%`}
                            style={`width: ${(group.percent / maxPercent) * 100}%`}
                        />
                    </div>
                </div>
            ))
        }
    </div>
</div>

<script is:inline src="https://d3js.org/d3.v7.min.js"></script>
<script is:inline>
    function initMaternalAgeAnimations() {
        const bars = document.querySelectorAll(
            "#maternal-age-chart [data-width]",
        );
        if (bars.length === 0) return;

        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const bar = entry.target;
                        const width = bar.getAttribute("data-width");
                        if (typeof d3 !== "undefined") {
                            d3.select(bar)
                                .transition() // D3 Transition
                                .duration(1000)
                                .ease(d3.easeCubicOut)
                                .style("width", width);
                        } else {
                            bar.style.width = width;
                        }
                    }
                });
            },
            { threshold: 0.2 },
        );

        bars.forEach((bar) => {
            bar.style.width = "0%";
            observer.observe(bar);
        });
    }

    if (document.readyState === "complete") {
        initMaternalAgeAnimations();
    } else {
        window.addEventListener("load", initMaternalAgeAnimations);
    }
    document.addEventListener("astro:page-load", initMaternalAgeAnimations);
</script>
