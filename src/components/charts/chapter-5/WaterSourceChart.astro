---
import type { Language } from "../../../lib/i18n";
import { formatNumber } from "../../../lib/i18n/formatters";

interface Props {
    lang: Language;
    data?: {
        type: string;
        percent: number;
        color?: string;
    }[];
}

const { lang, data } = Astro.props;

// Default colors
const colors = [
    "#f2e25d",
    "#d4c74f",
    "#a3a3a3",
    "#737373",
    "#525252",
    "#404040",
    "#262626",
];

// Water source distribution (fallback)
const waterSources = (
    data || [
        {
            type: lang === "ne" ? "ट्युवेल/हेन्डपम्प" : "Tube well/Hand pump",
            percent: 34.61,
        },
        {
            type:
                lang === "ne"
                    ? "पाइप धारा (घर भित्र)"
                    : "Piped water (inside home)",
            percent: 32.03,
        },
        {
            type:
                lang === "ne"
                    ? "पाइप धारा (घर बाहिर)"
                    : "Piped water (outside home)",
            percent: 19.92,
        },
        {
            type: lang === "ne" ? "नढाकिएको इनार" : "Uncovered well",
            percent: 7.14,
        },
        {
            type: lang === "ne" ? "ढाकिएको इनार" : "Covered well",
            percent: 4.94,
        },
        { type: lang === "ne" ? "अन्य" : "Others", percent: 1.36 },
    ]
).map((item, index) => ({
    ...item,
    color: item.color || colors[index % colors.length],
}));

const maxValue = Math.max(...waterSources.map((s) => s.percent));
---

<div
    id="water-source-chart"
    class="bg-[#0a0a0a] border border-[#f2e25d]/10 p-6 md:p-8"
>
    <h4 class="font-serif text-xl text-zinc-100 font-medium mb-6 text-center">
        {lang === "ne" ? "खानेपानीको स्रोत वितरण" : "Water Source Distribution"}
    </h4>

    <!-- Bar Chart -->
    <div class="space-y-3">
        {
            waterSources.map((source) => (
                <div class="space-y-1">
                    <div class="flex justify-between items-center">
                        <span class="text-zinc-100 font-serif text-sm">
                            {source.type}
                        </span>
                        <span class="text-[#f2e25d] font-bold">
                            {formatNumber(source.percent, lang)}%
                        </span>
                    </div>
                    <div class="bg-[#050505] h-8 relative border border-[#f2e25d]/10">
                        <div
                            class="absolute inset-y-0 left-0 transition-all duration-500 flex items-center justify-end pr-2"
                            data-width={`${(source.percent / maxValue) * 100}%`}
                            style={`width: ${(source.percent / maxValue) * 100}%; background-color: ${source.color}`}
                        >
                            {source.percent > 10 && (
                                <span class="text-black font-bold text-xs">
                                    {formatNumber(source.percent, lang)}%
                                </span>
                            )}
                        </div>
                    </div>
                </div>
            ))
        }
    </div>

    <div class="mt-6 pt-6 border-t border-[#f2e25d]/10 text-center">
        <p class="text-zinc-400 font-serif text-xs">
            {lang === "ne" ? "कुल घरपरिवार:" : "Total Households:"}
            {formatNumber(12703, lang)}
        </p>
    </div>
</div>

<script is:inline src="https://d3js.org/d3.v7.min.js"></script>
<script is:inline>
    function initWaterSourceAnimations() {
        const bars = document.querySelectorAll(
            "#water-source-chart [data-width]",
        ); // Add ID to container to be safe
        if (bars.length === 0) return;

        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const bar = entry.target;
                        const width = bar.getAttribute("data-width");

                        if (typeof d3 !== "undefined") {
                            d3.select(bar)
                                .transition()
                                .duration(1000)
                                .ease(d3.easeCubicOut)
                                .style("width", width);
                        } else {
                            bar.style.width = width;
                        }
                    }
                });
            },
            { threshold: 0.2 },
        );

        bars.forEach((bar) => {
            bar.style.width = "0%";
            observer.observe(bar);
        });
    }

    if (document.readyState === "complete") {
        initWaterSourceAnimations();
    } else {
        window.addEventListener("load", initWaterSourceAnimations);
    }
    document.addEventListener("astro:page-load", initWaterSourceAnimations);
</script>
