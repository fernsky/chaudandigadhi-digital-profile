---
import type { Language } from "../../../lib/i18n";
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

type AgeGenderData = {
    tableData: Array<{
        ageGroup: string;
        male: number;
        female: number;
        total: number;
    }>;
};

const content = await loadChapterSection<AgeGenderData>(3, "age-gender", lang);

if (!content) {
    throw new Error("Age gender data not found");
}

const data = content.tableData;
---

<div class="space-y-6">
    <div class="w-full max-w-4xl mx-auto">
        <svg
            id="population-pyramid"
            class="w-full h-auto"
            viewBox="0 0 800 600"
            style="background: transparent;"
        >
            <!-- Chart will be rendered by script -->
        </svg>
    </div>

    <!-- Legend -->
    <div class="flex items-center justify-center gap-8">
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-[#60a5fa] opacity-80"></div>
            <span class="text-zinc-300 font-serif text-sm">पुरूष (Male)</span>
        </div>
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-[#f472b6] opacity-80"></div>
            <span class="text-zinc-300 font-serif text-sm">महिला (Female)</span>
        </div>
    </div>
</div>

<script define:vars={{ data }}>
    function createPopulationPyramid() {
        const svg = document.getElementById("population-pyramid");
        if (!svg) return;

        // Clear existing content
        svg.innerHTML = "";

        const width = 800;
        const height = 600;
        const margin = { top: 40, right: 40, bottom: 50, left: 40 };
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;
        const centerX = width / 2;
        const centerGap = 60; // Gap for age labels in the middle

        // Calculate scales
        // Find max value across both male and female to symmetrical scale
        const maxVal = Math.max(...data.map((d) => Math.max(d.male, d.female)));
        // Add some padding to max value
        const xDomain = maxVal * 1.1;

        const barHeight = chartHeight / data.length;
        const barPadding = 4;
        const actualBarHeight = barHeight - barPadding;

        // Create main group
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        svg.appendChild(g);

        // Male Bars (Left Side)
        // x scale goes from center-gap/2 to 0 (visually leftwards)
        // Female Bars (Right Side)
        // x scale goes from center+gap/2 to width

        const maxBarWidth = (chartWidth - centerGap) / 2;

        data.forEach((item, i) => {
            const y = margin.top + i * barHeight;

            // Calculate widths
            const maleWidth = (item.male / xDomain) * maxBarWidth;
            const femaleWidth = (item.female / xDomain) * maxBarWidth;

            // MALE BAR (Left)
            const maleRect = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "rect",
            );
            maleRect.setAttribute(
                "x",
                (centerX - centerGap / 2 - maleWidth).toString(),
            );
            maleRect.setAttribute("y", y.toString());
            maleRect.setAttribute("width", maleWidth.toString());
            maleRect.setAttribute("height", actualBarHeight.toString());
            maleRect.setAttribute("fill", "#60a5fa"); // Blue for male
            maleRect.setAttribute("opacity", "0.8");
            maleRect.setAttribute(
                "class",
                "bar-hover transition-opacity duration-300",
            );

            // Add tooltip logic or title
            const maleTitle = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "title",
            );
            maleTitle.textContent = `Male (${item.ageGroup}): ${item.male.toLocaleString()}`;
            maleRect.appendChild(maleTitle);

            g.appendChild(maleRect);

            // FEMALE BAR (Right)
            const femaleRect = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "rect",
            );
            femaleRect.setAttribute("x", (centerX + centerGap / 2).toString());
            femaleRect.setAttribute("y", y.toString());
            femaleRect.setAttribute("width", femaleWidth.toString());
            femaleRect.setAttribute("height", actualBarHeight.toString());
            femaleRect.setAttribute("fill", "#f472b6"); // Pink for female
            femaleRect.setAttribute("opacity", "0.8");
            femaleRect.setAttribute(
                "class",
                "bar-hover transition-opacity duration-300",
            );

            const femaleTitle = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "title",
            );
            femaleTitle.textContent = `Female (${item.ageGroup}): ${item.female.toLocaleString()}`;
            femaleRect.appendChild(femaleTitle);

            g.appendChild(femaleRect);

            // AGE LABEL (Center)
            const ageText = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "text",
            );
            ageText.setAttribute("x", centerX.toString());
            ageText.setAttribute("y", (y + actualBarHeight / 2 + 5).toString()); // Center vertically
            ageText.setAttribute("text-anchor", "middle");
            ageText.setAttribute("fill", "#e4e4e7");
            ageText.setAttribute("font-size", "12");
            ageText.setAttribute("font-family", "serif");
            ageText.textContent = item.ageGroup;
            g.appendChild(ageText);

            // Value Labels (Optional - only if space permits or on hover? Let's hide for clean look unless bars are wide enough)
            // Or maybe place them outside?
        });

        // X-Axis Gridlines and Labels (Bottom)
        const ticks = 5;
        const tickStep = Math.round(xDomain / ticks / 500) * 500; // Round to nearest 500

        for (let val = 0; val <= xDomain; val += tickStep) {
            if (val === 0) continue; // Skip 0 as it's implied in center

            // Left side (Male)
            const xLeft =
                centerX - centerGap / 2 - (val / xDomain) * maxBarWidth;

            // Right side (Female)
            const xRight =
                centerX + centerGap / 2 + (val / xDomain) * maxBarWidth;

            // Gridlines
            [xLeft, xRight].forEach((x) => {
                const line = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "line",
                );
                line.setAttribute("x1", x.toString());
                line.setAttribute("y1", margin.top.toString());
                line.setAttribute("x2", x.toString());
                line.setAttribute("y2", (height - margin.bottom).toString());
                line.setAttribute("stroke", "#f2e25d");
                line.setAttribute("stroke-width", "1");
                line.setAttribute("opacity", "0.1");
                line.setAttribute("stroke-dasharray", "4 4");
                g.appendChild(line);

                // Labels
                const text = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "text",
                );
                text.setAttribute("x", x.toString());
                text.setAttribute(
                    "y",
                    (height - margin.bottom + 20).toString(),
                );
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("fill", "#a1a1aa");
                text.setAttribute("font-size", "10");
                text.setAttribute("font-family", "serif");
                text.textContent = val.toLocaleString();
                g.appendChild(text);
            });
        }

        // Axis Titles
        const maleLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
        );
        maleLabel.setAttribute(
            "x",
            (centerX - maxBarWidth / 2 - centerGap / 2).toString(),
        );
        maleLabel.setAttribute("y", (height - 10).toString());
        maleLabel.setAttribute("text-anchor", "middle");
        maleLabel.setAttribute("fill", "#60a5fa");
        maleLabel.setAttribute("font-size", "14");
        maleLabel.setAttribute("font-weight", "bold");
        maleLabel.setAttribute("font-family", "serif");
        maleLabel.textContent = "पुरूष जनसंख्या";
        g.appendChild(maleLabel);

        const femaleLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
        );
        femaleLabel.setAttribute(
            "x",
            (centerX + maxBarWidth / 2 + centerGap / 2).toString(),
        );
        femaleLabel.setAttribute("y", (height - 10).toString());
        femaleLabel.setAttribute("text-anchor", "middle");
        femaleLabel.setAttribute("fill", "#f472b6");
        femaleLabel.setAttribute("font-size", "14");
        femaleLabel.setAttribute("font-weight", "bold");
        femaleLabel.setAttribute("font-family", "serif");
        femaleLabel.textContent = "महिला जनसंख्या";
        g.appendChild(femaleLabel);
    }

    // Initialize
    if (document.readyState === "complete") {
        createPopulationPyramid();
    } else {
        window.addEventListener("load", createPopulationPyramid);
    }

    // Astro View Transitions
    document.addEventListener("astro:page-load", createPopulationPyramid);
</script>

<style>
    .bar-hover:hover {
        opacity: 1;
        stroke: white;
        stroke-width: 1px;
    }
</style>
