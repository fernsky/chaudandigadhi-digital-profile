---
import type { Language } from "../../../lib/i18n";
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

type AgeGenderData = {
    tableData: Array<{
        ageGroup: string;
        male: number;
        female: number;
        total: number;
    }>;
};

const content = await loadChapterSection<AgeGenderData>(3, "age-gender", lang);

if (!content) {
    throw new Error("Age gender data not found");
}

const data = content.tableData;
---

<div class="space-y-6">
    <div class="w-full max-w-4xl mx-auto">
        <svg
            id="population-pyramid"
            class="w-full h-auto"
            viewBox="0 0 800 600"
            style="background: transparent;"
        >
            <!-- Chart will be rendered by script -->
        </svg>
    </div>

    <!-- Legend -->
    <div class="flex items-center justify-center gap-8">
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-[#60a5fa] opacity-80"></div>
            <span class="text-zinc-300 font-serif text-sm"
                >{lang === "ne" ? "पुरूष" : "Male"}</span
            >
        </div>
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-[#f472b6] opacity-80"></div>
            <span class="text-zinc-300 font-serif text-sm"
                >{lang === "ne" ? "महिला" : "Female"}</span
            >
        </div>
    </div>
</div>

<script define:vars={{ data, lang }}>
    function createPopulationPyramid() {
        const svg = document.getElementById("population-pyramid");
        if (!svg) return;

        // Clear existing content
        svg.innerHTML = "";

        const formatValue = (num, decimals = 0) => {
            if (num === undefined || num === null || isNaN(num)) return "0";
            const formatted = num.toLocaleString("en-US", {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals,
            });
            if (lang !== "ne") return formatted;
            const nepaliDigits = [
                "०",
                "१",
                "२",
                "३",
                "४",
                "५",
                "६",
                "७",
                "८",
                "९",
            ];
            return formatted.replace(
                /\d/g,
                (digit) => nepaliDigits[parseInt(digit)],
            );
        };

        const translateAgeGroup = (ageStr) => ageStr;

        const width = 800;
        const height = 600;
        const margin = { top: 40, right: 40, bottom: 60, left: 40 };
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;
        const centerX = width / 2;
        const centerGap = 80; // Increased gap for age labels

        // Filter out any invalid items
        const validData = data.filter(
            (d) =>
                d &&
                d.ageGroup &&
                d.male !== undefined &&
                d.female !== undefined,
        );

        // Find max value across both male and female to symmetrical scale
        const maxVal = Math.max(
            ...validData.map((d) => Math.max(d.male || 0, d.female || 0)),
            1,
        );
        const xDomain = maxVal * 1.1;

        const barHeight = chartHeight / validData.length;
        const barPadding = 4;
        const actualBarHeight = barHeight - barPadding;

        // Create main group
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        svg.appendChild(g);

        const maxBarWidth = (chartWidth - centerGap) / 2;

        validData.forEach((item, i) => {
            const y = margin.top + i * barHeight;
            const translatedAge = translateAgeGroup(item.ageGroup);

            // Calculate widths
            const maleWidth = (item.male / xDomain) * maxBarWidth;
            const femaleWidth = (item.female / xDomain) * maxBarWidth;

            // MALE BAR (Left)
            const maleRect = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "rect",
            );
            maleRect.setAttribute(
                "x",
                (centerX - centerGap / 2 - maleWidth).toString(),
            );
            maleRect.setAttribute("y", y.toString());
            maleRect.setAttribute("width", maleWidth.toString());
            maleRect.setAttribute("height", actualBarHeight.toString());
            maleRect.setAttribute("fill", "#60a5fa");
            maleRect.setAttribute("opacity", "0.8");
            maleRect.setAttribute(
                "class",
                "bar-hover transition-opacity duration-300",
            );

            const maleTitle = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "title",
            );
            maleTitle.textContent =
                lang === "ne"
                    ? `पुरूष (${translatedAge}): ${formatValue(item.male)}`
                    : `Male (${translatedAge}): ${formatValue(item.male)}`;
            maleRect.appendChild(maleTitle);
            g.appendChild(maleRect);

            // FEMALE BAR (Right)
            const femaleRect = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "rect",
            );
            femaleRect.setAttribute("x", (centerX + centerGap / 2).toString());
            femaleRect.setAttribute("y", y.toString());
            femaleRect.setAttribute("width", femaleWidth.toString());
            femaleRect.setAttribute("height", actualBarHeight.toString());
            femaleRect.setAttribute("fill", "#f472b6");
            femaleRect.setAttribute("opacity", "0.8");
            femaleRect.setAttribute(
                "class",
                "bar-hover transition-opacity duration-300",
            );

            const femaleTitle = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "title",
            );
            femaleTitle.textContent =
                lang === "ne"
                    ? `महिला (${translatedAge}): ${formatValue(item.female)}`
                    : `Female (${translatedAge}): ${formatValue(item.female)}`;
            femaleRect.appendChild(femaleTitle);
            g.appendChild(femaleRect);

            // AGE LABEL (Center)
            const ageText = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "text",
            );
            ageText.setAttribute("x", centerX.toString());
            ageText.setAttribute("y", (y + actualBarHeight / 2 + 5).toString());
            ageText.setAttribute("text-anchor", "middle");
            ageText.setAttribute("fill", "#e4e4e7");
            ageText.setAttribute("font-size", "11");
            ageText.setAttribute("font-family", "serif");
            ageText.textContent = translatedAge;
            g.appendChild(ageText);
        });

        // X-Axis Gridlines and Labels
        const ticksCount = 5;
        const tickStep = Math.max(
            100,
            Math.round(xDomain / ticksCount / 100) * 100,
        );

        for (let val = 0; val <= xDomain; val += tickStep) {
            const xLeft =
                centerX - centerGap / 2 - (val / xDomain) * maxBarWidth;
            const xRight =
                centerX + centerGap / 2 + (val / xDomain) * maxBarWidth;

            [xLeft, xRight].forEach((x) => {
                if (val !== 0) {
                    const line = document.createElementNS(
                        "http://www.w3.org/2000/svg",
                        "line",
                    );
                    line.setAttribute("x1", x.toString());
                    line.setAttribute("y1", margin.top.toString());
                    line.setAttribute("x2", x.toString());
                    line.setAttribute(
                        "y2",
                        (height - margin.bottom).toString(),
                    );
                    line.setAttribute("stroke", "#f2e25d");
                    line.setAttribute("opacity", "0.1");
                    line.setAttribute("stroke-dasharray", "4 4");
                    g.appendChild(line);
                }

                const text = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "text",
                );
                text.setAttribute("x", x.toString());
                text.setAttribute(
                    "y",
                    (height - margin.bottom + 20).toString(),
                );
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("fill", "#a1a1aa");
                text.setAttribute("font-size", "10");
                text.setAttribute("font-family", "serif");
                text.textContent = formatValue(val);
                g.appendChild(text);
            });
        }

        // Axis Titles
        const maleAxisTitle = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
        );
        maleAxisTitle.setAttribute(
            "x",
            (centerX - centerGap / 2 - maxBarWidth / 2).toString(),
        );
        maleAxisTitle.setAttribute("y", (height - 5).toString());
        maleAxisTitle.setAttribute("text-anchor", "middle");
        maleAxisTitle.setAttribute("fill", "#60a5fa");
        maleAxisTitle.setAttribute("font-size", "14");
        maleAxisTitle.setAttribute("font-weight", "500");
        maleAxisTitle.textContent =
            lang === "ne" ? "पुरूष जनसंख्या" : "Male Population";
        g.appendChild(maleAxisTitle);

        const femaleAxisTitle = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
        );
        femaleAxisTitle.setAttribute(
            "x",
            (centerX + centerGap / 2 + maxBarWidth / 2).toString(),
        );
        femaleAxisTitle.setAttribute("y", (height - 5).toString());
        femaleAxisTitle.setAttribute("text-anchor", "middle");
        femaleAxisTitle.setAttribute("fill", "#f472b6");
        femaleAxisTitle.setAttribute("font-size", "14");
        femaleAxisTitle.setAttribute("font-weight", "500");
        femaleAxisTitle.textContent =
            lang === "ne" ? "महिला जनसंख्या" : "Female Population";
        g.appendChild(femaleAxisTitle);
    }

    // Initialize
    if (document.readyState === "complete") {
        createPopulationPyramid();
    } else {
        window.addEventListener("load", createPopulationPyramid);
    }

    // Astro View Transitions
    document.addEventListener("astro:page-load", createPopulationPyramid);
</script>

<style>
    .bar-hover:hover {
        opacity: 1;
        stroke: white;
        stroke-width: 1px;
    }
</style>
