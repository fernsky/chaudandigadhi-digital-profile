---
import type { Language } from "../../../lib/i18n";
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

type MotherTongueData = {
    tableData: Array<{
        language: string;
        male: number;
        female: number;
        total: number;
        percentage: number;
    }>;
};

const content = await loadChapterSection<MotherTongueData>(
    3,
    "mother-tongue",
    lang,
);

if (!content) {
    throw new Error("Mother tongue data not found");
}

const data = content.tableData;
---

<div
    class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center bg-[#0a0a0a] border border-[#f2e25d]/10 p-6 rounded-lg"
>
    <!-- Chart -->
    <div class="relative aspect-square max-w-[400px] mx-auto w-full">
        <svg
            id="language-chart"
            class="w-full h-full transform -rotate-90"
            viewBox="0 0 100 100"
        >
            <!-- Chart will be rendered by script -->
        </svg>
        <!-- Center Text -->
        <div
            class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"
        >
            <span class="text-zinc-500 font-serif text-sm">कुल जनसंख्या</span>
            <span class="text-[#f2e25d] font-serif text-2xl font-bold">
                {
                    data
                        .reduce((acc, curr) => acc + curr.total, 0)
                        .toLocaleString()
                }
            </span>
        </div>
    </div>

    <!-- Legend -->
    <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
        {
            data.map((item, index) => (
                <div class="flex items-center justify-between group p-2 rounded hover:bg-[#f2e25d]/5 transition-colors">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-4 h-4 rounded-sm"
                            id={`legend-color-${index}`}
                        />
                        <span class="text-zinc-100 font-serif">
                            {item.language}
                        </span>
                    </div>
                    <div class="text-right">
                        <div class="text-[#f2e25d] font-serif font-medium">
                            {item.percentage.toFixed(2)}%
                        </div>
                        <div class="text-zinc-500 text-xs font-serif">
                            {item.total.toLocaleString()}
                        </div>
                    </div>
                </div>
            ))
        }
    </div>
</div>

<script define:vars={{ data }}>
    function createLanguageChart() {
        const svg = document.getElementById("language-chart");
        if (!svg) return;

        // Clear existing content
        svg.innerHTML = "";

        const radius = 50;
        const center = 50;
        const total = data.reduce((acc, curr) => acc + curr.total, 0);
        let currentAngle = 0;

        // Premium Color Palette
        const colors = [
            "#f2e25d", // Gold
            "#eab308", // Yellow-600
            "#ca8a04", // Yellow-700
            "#a16207", // Yellow-800
            "#60a5fa", // Blue-400
            "#3b82f6", // Blue-500
            "#f472b6", // Pink-400
            "#ec4899", // Pink-500
            "#34d399", // Emerald-400
            "#10b981", // Emerald-500
            "#a78bfa", // Violet-400
            "#8b5cf6", // Violet-500
            "#fb923c", // Orange-400
            "#f97316", // Orange-500
        ];

        data.forEach((item, index) => {
            const percentage = item.total / total;
            const angle = percentage * 360;
            const color = colors[index % colors.length];

            // Update legend color
            const legendDot = document.getElementById(`legend-color-${index}`);
            if (legendDot) {
                legendDot.style.backgroundColor = color;
            }

            // Create Slice
            // Calculate coordinates
            const startRad = (currentAngle * Math.PI) / 180;
            const endRad = ((currentAngle + angle) * Math.PI) / 180;

            const x1 = center + radius * Math.cos(startRad);
            const y1 = center + radius * Math.sin(startRad);
            const x2 = center + radius * Math.cos(endRad);
            const y2 = center + radius * Math.sin(endRad);

            // Large arc flag
            const largeArcFlag = angle > 180 ? 1 : 0;

            // Donut hole radius
            const innerRadius = 35;
            const x3 = center + innerRadius * Math.cos(endRad);
            const y3 = center + innerRadius * Math.sin(endRad);
            const x4 = center + innerRadius * Math.cos(startRad);
            const y4 = center + innerRadius * Math.sin(startRad);

            const pathData = [
                `M ${x1} ${y1}`,
                `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                `L ${x3} ${y3}`,
                `A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x4} ${y4}`,
                `Z`,
            ].join(" ");

            const path = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "path",
            );
            path.setAttribute("d", pathData);
            path.setAttribute("fill", color);
            path.setAttribute("opacity", "0.9");
            path.setAttribute(
                "class",
                "hover:opacity-100 transition-opacity duration-300 cursor-pointer",
            );

            // Add tooltip
            const title = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "title",
            );
            title.textContent = `${item.language}: ${item.total.toLocaleString()} (${item.percentage.toFixed(2)}%)`;
            path.appendChild(title);

            svg.appendChild(path);

            // Add separator line
            const separator = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "line",
            );
            separator.setAttribute("x1", center.toString());
            separator.setAttribute("y1", center.toString());
            separator.setAttribute("x2", x2.toString());
            separator.setAttribute("y2", y2.toString());
            separator.setAttribute("stroke", "#0a0a0a");
            separator.setAttribute("stroke-width", "0.5");
            svg.appendChild(separator);

            currentAngle += angle;
        });
    }

    // Initialize
    if (document.readyState === "complete") {
        createLanguageChart();
    } else {
        window.addEventListener("load", createLanguageChart);
    }

    document.addEventListener("astro:page-load", createLanguageChart);
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #0a0a0a;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #f2e25d33;
        border-radius: 2px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #f2e25d66;
    }
</style>
