---
import type { Language } from "../../../lib/i18n";
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

type MigrationData = {
    subsections: {
        previousResidence: {
            tableData: Array<{
                type: string;
                total: number;
                percentage: number;
            }>;
            total: {
                total: number;
            };
        };
    };
};

const content = await loadChapterSection<MigrationData>(3, "migration", lang);

if (!content) {
    throw new Error("Migration data not found");
}

const data = content.subsections.previousResidence.tableData;
const totalPopulation = content.subsections.previousResidence.total.total;
---

<div
    class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center bg-[#0a0a0a] border border-[#f2e25d]/10 p-6 rounded-lg"
>
    <!-- Chart -->
    <div class="relative aspect-square max-w-[400px] mx-auto w-full">
        <svg id="migration-chart"></svg>
        <!-- Center Text -->
        <div
            class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"
        >
            <span class="text-zinc-500 font-serif text-sm">कुल जनसंख्या</span>
            <span class="text-[#f2e25d] font-serif text-2xl font-bold">
                {totalPopulation.toLocaleString()}
            </span>
        </div>
    </div>

    <!-- Legend -->
    <div class="space-y-3">
        <h4
            class="text-zinc-100 font-serif mb-4 pb-2 border-b border-[#f2e25d]/10"
        >
            बसाइँसराईको किसिम
        </h4>
        {
            data.map((item, index) => (
                <div class="flex items-center justify-between group p-2 rounded hover:bg-[#f2e25d]/5 transition-colors">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-4 h-4 rounded-sm"
                            id={`migration-legend-color-${index}`}
                        />
                        <span class="text-zinc-100 font-serif text-sm">
                            {item.type}
                        </span>
                    </div>
                    <div class="text-right">
                        <div class="text-[#f2e25d] font-serif font-medium">
                            {item.percentage.toFixed(2)}%
                        </div>
                        <div class="text-zinc-500 text-xs font-serif">
                            {item.total.toLocaleString()}
                        </div>
                    </div>
                </div>
            ))
        }
    </div>
</div>

<script is:inline src="https://d3js.org/d3.v7.min.js"></script>
<script define:vars={{ data }}>
    function createMigrationChart() {
        const svgEl = document.getElementById("migration-chart");
        if (!svgEl) return;

        // Reset
        svgEl.innerHTML = "";

        const width = 100;
        const height = 100;
        const radius = Math.min(width, height) / 2;

        // Setup D3
        const svg = d3
            .select(svgEl)
            .attr("viewBox", `0 0 ${width} ${height}`)
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        const colors = [
            "#f2e25d", // Gold
            "#60a5fa", // Blue
            "#f472b6", // Pink
            "#34d399", // Green
            "#a78bfa", // Purple
        ];

        const pie = d3
            .pie()
            .value((d) => d.total)
            .sort(null);

        const arc = d3.arc().innerRadius(35).outerRadius(50);

        const paths = svg
            .selectAll("path")
            .data(pie(data))
            .enter()
            .append("path")
            .attr("fill", (d, i) => colors[i % colors.length])
            .attr("d", arc)
            .attr("opacity", "0.9")
            .attr(
                "class",
                "hover:opacity-100 transition-opacity duration-300 cursor-pointer",
            )
            .each(function (d) {
                this._current = d;
            }); // Store initial angles

        // Legend Interaction
        data.forEach((item, index) => {
            const legendDot = document.getElementById(
                `migration-legend-color-${index}`,
            );
            if (legendDot)
                legendDot.style.backgroundColor = colors[index % colors.length];
        });

        // Animation: Start from 0 angle
        paths
            .transition()
            .duration(1000)
            .attrTween("d", function (d) {
                var i = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
                return function (t) {
                    return arc(i(t));
                };
            });
    }

    const initMigration = () => {
        const el = document.getElementById("migration-chart");
        if (!el) return;
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        createMigrationChart();
                        observer.unobserve(entry.target);
                    }
                });
            },
            { threshold: 0.2 },
        );
        observer.observe(el);
    };

    if (document.readyState === "complete") {
        initMigration();
    } else {
        window.addEventListener("load", initMigration);
    }
    document.addEventListener("astro:page-load", initMigration);
</script>
