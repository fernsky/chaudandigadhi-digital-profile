---
import type { Language } from "../../../lib/i18n";
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

type MigrationData = {
    subsections: {
        previousResidence: {
            tableData: Array<{
                type: string;
                total: number;
                percentage: number;
            }>;
            total: {
                total: number;
            };
        };
    };
};

const content = await loadChapterSection<MigrationData>(3, "migration", lang);

if (!content) {
    throw new Error("Migration data not found");
}

const data = content.subsections.previousResidence.tableData;
const totalPopulation = content.subsections.previousResidence.total.total;
---

<div
    class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center bg-[#0a0a0a] border border-[#f2e25d]/10 p-6 rounded-lg"
>
    <!-- Chart -->
    <div class="relative aspect-square max-w-[400px] mx-auto w-full">
        <svg
            id="migration-chart"
            class="w-full h-full transform -rotate-90"
            viewBox="0 0 100 100"
        >
            <!-- Chart will be rendered by script -->
        </svg>
        <!-- Center Text -->
        <div
            class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"
        >
            <span class="text-zinc-500 font-serif text-sm">कुल जनसंख्या</span>
            <span class="text-[#f2e25d] font-serif text-2xl font-bold">
                {totalPopulation.toLocaleString()}
            </span>
        </div>
    </div>

    <!-- Legend -->
    <div class="space-y-3">
        <h4
            class="text-zinc-100 font-serif mb-4 pb-2 border-b border-[#f2e25d]/10"
        >
            बसाइँसराईको किसिम
        </h4>
        {
            data.map((item, index) => (
                <div class="flex items-center justify-between group p-2 rounded hover:bg-[#f2e25d]/5 transition-colors">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-4 h-4 rounded-sm"
                            id={`migration-legend-color-${index}`}
                        />
                        <span class="text-zinc-100 font-serif text-sm">
                            {item.type}
                        </span>
                    </div>
                    <div class="text-right">
                        <div class="text-[#f2e25d] font-serif font-medium">
                            {item.percentage.toFixed(2)}%
                        </div>
                        <div class="text-zinc-500 text-xs font-serif">
                            {item.total.toLocaleString()}
                        </div>
                    </div>
                </div>
            ))
        }
    </div>
</div>

<script define:vars={{ data }}>
    function createMigrationChart() {
        const svg = document.getElementById("migration-chart");
        if (!svg) return;

        svg.innerHTML = "";

        const radius = 50;
        const center = 50;
        const total = data.reduce((acc, curr) => acc + curr.total, 0);
        let currentAngle = 0;

        // Premium Color Palette
        const colors = [
            "#f2e25d", // Gold (Primary)
            "#60a5fa", // Blue
            "#f472b6", // Pink
            "#34d399", // Green
            "#a78bfa", // Purple
        ];

        data.forEach((item, index) => {
            const percentage = item.total / total;
            const angle = percentage * 360;
            const color = colors[index % colors.length];

            // Update legend color
            const legendDot = document.getElementById(
                `migration-legend-color-${index}`,
            );
            if (legendDot) {
                legendDot.style.backgroundColor = color;
            }

            // Create Slice
            const startRad = (currentAngle * Math.PI) / 180;
            const endRad = ((currentAngle + angle) * Math.PI) / 180;

            const x1 = center + radius * Math.cos(startRad);
            const y1 = center + radius * Math.sin(startRad);
            const x2 = center + radius * Math.cos(endRad);
            const y2 = center + radius * Math.sin(endRad);

            const largeArcFlag = angle > 180 ? 1 : 0;
            const innerRadius = 35; // Donut thickness

            const x3 = center + innerRadius * Math.cos(endRad);
            const y3 = center + innerRadius * Math.sin(endRad);
            const x4 = center + innerRadius * Math.cos(startRad);
            const y4 = center + innerRadius * Math.sin(startRad);

            const pathData = [
                `M ${x1} ${y1}`,
                `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                `L ${x3} ${y3}`,
                `A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x4} ${y4}`,
                `Z`,
            ].join(" ");

            const path = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "path",
            );
            path.setAttribute("d", pathData);
            path.setAttribute("fill", color);
            path.setAttribute("opacity", "0.9");
            path.setAttribute(
                "class",
                "hover:opacity-100 transition-opacity duration-300 cursor-pointer",
            );

            const title = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "title",
            );
            title.textContent = `${item.type}: ${item.total.toLocaleString()} (${item.percentage.toFixed(2)}%)`;
            path.appendChild(title);

            svg.appendChild(path);

            const separator = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "line",
            );
            separator.setAttribute("x1", center.toString());
            separator.setAttribute("y1", center.toString());
            separator.setAttribute("x2", x2.toString());
            separator.setAttribute("y2", y2.toString());
            separator.setAttribute("stroke", "#0a0a0a");
            separator.setAttribute("stroke-width", "0.5");
            svg.appendChild(separator);

            currentAngle += angle;
        });
    }

    if (document.readyState === "complete") {
        createMigrationChart();
    } else {
        window.addEventListener("load", createMigrationChart);
    }

    document.addEventListener("astro:page-load", createMigrationChart);
</script>
