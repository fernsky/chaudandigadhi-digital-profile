---
import type { Language } from "../../../lib/i18n";
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

type DisabilityData = {
    total: Record<string, number>;
    columns: Record<string, string>;
};

const content = await loadChapterSection<DisabilityData>(3, "disability", lang);

if (!content) {
    throw new Error("Disability data not found");
}

const { total, columns } = content;

// Transform data for chart: array of { type: string, count: number }
// Filter out 'total' key
const chartData = Object.entries(total)
    .filter(([key]) => key !== "total")
    .map(([key, count]) => ({
        type: columns[key] || key,
        count: count as number,
        key,
    }))
    .sort((a, b) => b.count - a.count); // Detailed sort
---

<div class="space-y-6">
    <div class="w-full max-w-4xl mx-auto">
        <svg
            id="disability-chart"
            class="w-full"
            style="background: transparent;"
        >
            <!-- Chart will be rendered by script -->
        </svg>
    </div>
</div>

<script define:vars={{ data: chartData }}>
    function createDisabilityChart() {
        const svg = document.getElementById("disability-chart");
        if (!svg) return;

        svg.innerHTML = "";

        const margin = { top: 20, right: 60, bottom: 20, left: 220 };
        const width = 800;
        const barHeight = 35;
        const gap = 12;
        const height =
            margin.top + margin.bottom + data.length * (barHeight + gap);

        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);

        const chartWidth = width - margin.left - margin.right;
        const maxCount = Math.max(...data.map((d) => d.count));

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        svg.appendChild(g);

        data.forEach((item, i) => {
            const y = margin.top + i * (barHeight + gap);
            const barWidth = (item.count / maxCount) * chartWidth;

            // Label
            const label = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "text",
            );
            label.setAttribute("x", (margin.left - 10).toString());
            label.setAttribute("y", (y + barHeight / 2 + 5).toString());
            label.setAttribute("text-anchor", "end");
            label.setAttribute("fill", "#e4e4e7");
            label.setAttribute("font-family", "serif");
            label.setAttribute("font-size", "14");
            label.textContent = item.type;
            g.appendChild(label);

            // Bar Background
            const bgRect = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "rect",
            );
            bgRect.setAttribute("x", margin.left.toString());
            bgRect.setAttribute("y", y.toString());
            bgRect.setAttribute("width", chartWidth.toString());
            bgRect.setAttribute("height", barHeight.toString());
            bgRect.setAttribute("fill", "#f2e25d");
            bgRect.setAttribute("opacity", "0.05");
            bgRect.setAttribute("rx", "4");
            g.appendChild(bgRect);

            // Bar
            const rect = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "rect",
            );
            rect.setAttribute("x", margin.left.toString());
            rect.setAttribute("y", y.toString());
            rect.setAttribute("width", barWidth.toString());
            rect.setAttribute("height", barHeight.toString());
            rect.setAttribute("fill", "#f2e25d");
            rect.setAttribute("opacity", "0.8");
            rect.setAttribute("rx", "4");
            rect.setAttribute("class", "bar-hover transition-all duration-300");
            g.appendChild(rect);

            // Count Label
            const text = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "text",
            );
            text.setAttribute("x", (margin.left + barWidth + 10).toString());
            text.setAttribute("y", (y + barHeight / 2 + 5).toString());
            text.setAttribute("fill", "#f2e25d");
            text.setAttribute("font-family", "serif");
            text.setAttribute("font-weight", "500");
            text.textContent = item.count.toLocaleString();
            g.appendChild(text);

            // Tooltip
            const title = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "title",
            );
            title.textContent = `${item.type}: ${item.count.toLocaleString()}`;
            rect.appendChild(title);
        });
    }

    if (document.readyState === "complete") {
        createDisabilityChart();
    } else {
        window.addEventListener("load", createDisabilityChart);
    }

    document.addEventListener("astro:page-load", createDisabilityChart);
</script>

<style>
    .bar-hover:hover {
        opacity: 1;
        fill: #fbbf24;
    }
</style>
