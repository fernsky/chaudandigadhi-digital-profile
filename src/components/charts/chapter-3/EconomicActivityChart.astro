---
import type { Language } from "../../../lib/i18n";
import { loadChapterSection } from "../../../lib/i18n/chapter-loader";

interface Props {
    lang: Language;
}

const { lang } = Astro.props;

type EconomicActivityData = {
    table13: {
        title: string;
        data: Array<{
            duration: string;
            total: number;
            percentage: number;
        }>;
    };
    table14: {
        title: string;
        total: {
            total: number;
        };
        percentages: {
            active: number;
            inactive: number;
        };
    };
};

const content = await loadChapterSection<EconomicActivityData>(
    3,
    "economic-activity",
    lang,
);

if (!content) {
    throw new Error("Economic activity data not found");
}

const table13Data = content.table13;
const table14Data = content.table14;
---

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Chart 1: Work Duration (Bar Chart) -->
    <div class="bg-[#0a0a0a] border border-[#f2e25d]/10 p-6 rounded-lg">
        <h4 class="text-zinc-100 font-serif text-lg mb-6 text-center">
            काम गरेको अवधि (Work Duration)
        </h4>
        <div class="w-full">
            <svg
                id="duration-chart"
                class="w-full"
                style="background: transparent;"
            >
                <!-- Work Duration Chart -->
            </svg>
        </div>
    </div>

    <!-- Chart 2: Active vs Inactive (Donut Chart) -->
    <div
        class="bg-[#0a0a0a] border border-[#f2e25d]/10 p-6 rounded-lg flex flex-col items-center"
    >
        <h4 class="text-zinc-100 font-serif text-lg mb-6 text-center">
            आर्थिक सक्रियता (Economic Activity)
        </h4>
        <div class="relative w-full max-w-[300px] aspect-square">
            <svg
                id="activity-status-chart"
                class="w-full h-full transform -rotate-90"
                viewBox="0 0 100 100"
            >
                <!-- Activity Status Chart -->
            </svg>
            <!-- Center Text -->
            <div
                class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"
            >
                <span class="text-zinc-500 font-serif text-sm"
                    >जम्मा जनसंख्या</span
                >
                <span class="text-[#f2e25d] font-serif text-xl font-bold">
                    {table14Data.total.total.toLocaleString()}
                </span>
            </div>
        </div>

        <!-- Legend for Donut -->
        <div class="flex gap-6 mt-6">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-[#f2e25d]"></div>
                <div class="flex flex-col">
                    <span class="text-zinc-100 text-sm font-serif"
                        >सक्रिय (Active)</span
                    >
                    <span class="text-[#f2e25d] text-xs font-serif"
                        >{table14Data.percentages.active}%</span
                    >
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-[#a1a1aa]"></div>
                <div class="flex flex-col">
                    <span class="text-zinc-100 text-sm font-serif"
                        >निस्क्रिय (Inactive)</span
                    >
                    <span class="text-zinc-400 text-xs font-serif"
                        >{table14Data.percentages.inactive}%</span
                    >
                </div>
            </div>
        </div>
    </div>
</div>

<script is:inline src="https://d3js.org/d3.v7.min.js"></script>
<script define:vars={{ table13Data, table14Data }}>
    function initEconomicCharts() {
        const observeChart = (id, renderFn) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.innerHTML = ""; // Clear

            const observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            renderFn();
                            observer.unobserve(entry.target);
                        }
                    });
                },
                { threshold: 0.2 },
            );
            observer.observe(el);
        };

        observeChart("duration-chart", renderDurationChart);
        observeChart("activity-status-chart", renderActivityStatusChart);
    }

    function renderDurationChart() {
        const svgEl = document.getElementById("duration-chart");
        if (!svgEl) return;

        const data = table13Data.data;
        const margin = { top: 20, right: 40, bottom: 20, left: 160 };
        const width = 500;
        const barHeight = 40;
        const gap = 15;
        const height =
            margin.top + margin.bottom + data.length * (barHeight + gap);
        const chartWidth = width - margin.left - margin.right;
        const maxPercentage = Math.max(...data.map((d) => d.percentage));

        const svg = d3.select(svgEl).attr("viewBox", `0 0 ${width} ${height}`);

        const g = svg.append("g");

        data.forEach((item, i) => {
            const y = margin.top + i * (barHeight + gap);
            const barWidth = (item.percentage / maxPercentage) * chartWidth;

            // Label
            let labelText = item.duration;
            if (labelText.length > 20)
                labelText = labelText.substring(0, 18) + "...";

            g.append("text")
                .attr("x", margin.left - 10)
                .attr("y", y + barHeight / 2 + 5)
                .attr("text-anchor", "end")
                .attr("fill", "#e4e4e7")
                .attr("font-family", "serif")
                .attr("font-size", "12")
                .text(labelText)
                .append("title")
                .text(item.duration);

            // Bg
            g.append("rect")
                .attr("x", margin.left)
                .attr("y", y)
                .attr("width", chartWidth)
                .attr("height", barHeight)
                .attr("fill", "#f2e25d")
                .attr("opacity", "0.05")
                .attr("rx", 4);

            // Bar
            g.append("rect")
                .attr("x", margin.left)
                .attr("y", y)
                .attr("height", barHeight)
                .attr("fill", "#f2e25d")
                .attr("opacity", "0.8")
                .attr("rx", 4)
                .attr("class", "bar-hover transition-all duration-300")
                .attr("width", 0) // Start 0
                .transition()
                .duration(1000)
                .attr("width", barWidth);

            // Text
            g.append("text")
                .attr("x", margin.left + barWidth + 5)
                .attr("y", y + barHeight / 2 + 5)
                .attr("fill", "#f2e25d")
                .attr("font-family", "serif")
                .attr("font-size", "12")
                .text(`${item.percentage}%`)
                .attr("opacity", 0)
                .transition()
                .delay(800)
                .duration(500)
                .attr("opacity", 1);
        });
    }

    function renderActivityStatusChart() {
        const svgEl = document.getElementById("activity-status-chart");
        if (!svgEl) return;

        const activePct = table14Data.percentages.active;
        const inactivePct = table14Data.percentages.inactive;
        const data = [
            { value: activePct, color: "#f2e25d", label: "Active" },
            { value: inactivePct, color: "#a1a1aa", label: "Inactive" },
        ];

        const width = 100;
        const height = 100;
        const radius = 50;

        const svg = d3
            .select(svgEl)
            .attr("viewBox", `0 0 ${width} ${height}`) // Ensure viewbox
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        const pie = d3
            .pie()
            .value((d) => d.value)
            .sort(null);
        const arc = d3.arc().innerRadius(38).outerRadius(50);

        const paths = svg
            .selectAll("path")
            .data(pie(data))
            .enter()
            .append("path")
            .attr("fill", (d) => d.data.color)
            .attr("d", arc)
            .attr("class", "bar-hover transition-all duration-300")
            .each(function (d) {
                this._current = d;
            });

        // Animate
        paths
            .transition()
            .duration(1000)
            .attrTween("d", function (d) {
                var i = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
                return function (t) {
                    return arc(i(t));
                };
            });

        // Separators
        // (Skipping separators for cleaner D3 look, or add if critical)
    }

    if (document.readyState === "complete") {
        initEconomicCharts();
    } else {
        window.addEventListener("load", initEconomicCharts);
    }
    document.addEventListener("astro:page-load", initEconomicCharts);
</script>

<style>
    .bar-hover:hover {
        opacity: 0.9;
        filter: brightness(1.1);
    }
</style>
