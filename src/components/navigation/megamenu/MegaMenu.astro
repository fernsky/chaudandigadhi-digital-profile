---
import type { Language } from "../../../lib/i18n";
import { getTranslations, allChapters } from "../../../lib/i18n";
import { ChevronDown } from "lucide-astro";
import MegaMenuCategoryNav from "./MegaMenuCategoryNav.astro";
import MegaMenuContent from "./MegaMenuContent.astro";

interface Props {
  lang: Language;
  currentChapter?: number;
}

const { lang, currentChapter } = Astro.props;
const t = getTranslations(lang);
---

<!-- Mega Menu Dropdown -->
<div class="relative" id="mega-menu-container">
  <button
    class="font-serif tracking-wide text-sm md:text-base font-medium transition-all duration-200 flex items-center gap-2 text-slate-300 hover:text-white"
    aria-expanded="false"
    id="mega-menu-trigger"
    type="button"
  >
    {t.nav.chapters}
    <ChevronDown
      size={16}
      class="transition-transform duration-200 chevron-icon"
    />
  </button>

  <!-- Full-Width Mega Menu Dropdown -->
  <div
    id="mega-menu-dropdown"
    class="fixed left-0 opacity-0 invisible transition-opacity duration-200 ease-out pointer-events-none"
    style="top: 100%; height: 60vh; width: 100%; right: 0;"
  >
    <!-- Background -->
    <div class="absolute inset-0 bg-slate-950 border-t border-slate-700"></div>

    <!-- Container aligned with logo -->
    <div class="w-full h-full relative py-6">
      <div class="container mx-auto px-4 md:px-6 h-full">
        <div class="flex gap-0 h-full max-w-full">
          <!-- Left: Categories Navigation -->
          <MegaMenuCategoryNav
            lang={lang}
            currentChapter={currentChapter}
            allChapters={allChapters}
          />

          <!-- Right: Content Area (Sections) -->
          <MegaMenuContent lang={lang} currentChapter={currentChapter} />
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Ensure mega menu doesn't overflow */
  #mega-menu-dropdown {
    max-width: 100vw;
    overflow-x: hidden;
  }

  #mega-menu-dropdown.show {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  #mega-menu-trigger:hover .chevron-icon,
  #mega-menu-trigger.active .chevron-icon {
    transform: rotate(180deg);
  }

  /* Make header background match menu when open */
  :global(header.menu-open) {
    background-color: rgb(2 6 23) !important; /* bg-slate-950 */
    border-bottom-color: rgb(30 41 59) !important; /* border-slate-800 */
  }
</style>

<script>
  // Mega menu hover functionality
  const megaMenuContainer = document.getElementById("mega-menu-container");
  const megaMenuTrigger = document.getElementById("mega-menu-trigger");
  const megaMenuDropdown = document.getElementById("mega-menu-dropdown");
  const header = document.querySelector("header");

  let hideTimeout: number | null = null;

  function showMenu() {
    if (hideTimeout) {
      clearTimeout(hideTimeout);
      hideTimeout = null;
    }

    if (megaMenuDropdown && header) {
      // Position the dropdown right below the header (no gap)
      const headerRect = header.getBoundingClientRect();
      megaMenuDropdown.style.top = `${headerRect.bottom}px`;

      // Show dropdown
      megaMenuDropdown.classList.add("show");
      megaMenuTrigger?.classList.add("active");
      megaMenuTrigger?.setAttribute("aria-expanded", "true");

      // Update header background
      header.classList.add("menu-open");
    }
  }

  function hideMenu() {
    hideTimeout = window.setTimeout(() => {
      if (megaMenuDropdown) {
        megaMenuDropdown.classList.remove("show");
        megaMenuTrigger?.classList.remove("active");
        megaMenuTrigger?.setAttribute("aria-expanded", "false");

        // Remove header background
        header?.classList.remove("menu-open");
      }
    }, 150);
  }

  // Trigger hover events
  if (megaMenuContainer && megaMenuTrigger && megaMenuDropdown) {
    megaMenuTrigger.addEventListener("mouseenter", showMenu);
    megaMenuContainer.addEventListener("mouseleave", hideMenu);

    megaMenuDropdown.addEventListener("mouseenter", () => {
      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }
    });

    megaMenuDropdown.addEventListener("mouseleave", hideMenu);

    // Keyboard support
    megaMenuTrigger.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        const isExpanded =
          megaMenuTrigger.getAttribute("aria-expanded") === "true";

        if (isExpanded) {
          hideMenu();
        } else {
          showMenu();
        }
      }
    });
  }
</script>
