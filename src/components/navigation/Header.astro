---
import type { Language } from "../../lib/i18n";
import { getTranslations } from "../../lib/i18n";
import LanguageSwitcher from "./LanguageSwitcher.astro";
import ThemeToggle from "./ThemeToggle.astro";
import MegaMenu from "./megamenu/MegaMenu.astro";
import MobileMegaMenu from "./megamenu/MobileMegaMenu.astro";
import { Menu, X } from "lucide-astro";

interface Props {
  lang: Language;
  currentChapter?: number;
  hideMegaMenu?: boolean;
}

const { lang, currentChapter, hideMegaMenu = false } = Astro.props;
const t = getTranslations(lang);

// Check if we are on the home page
const pathname = Astro.url.pathname;
const isHomePage =
  pathname === `/${lang}` ||
  pathname === `/${lang}/` ||
  pathname === "/" ||
  pathname === "";

// Determine header classes based on page
// On home page: absolute, transparent background initially (can add scroll listener later if needed)
// On other pages: sticky, solid background
const headerClass = isHomePage
  ? "absolute top-0 left-0 right-0 z-50 transition-all duration-200 border-b border-white/10"
  : "sticky top-0 z-50 bg-[#050505]/95 backdrop-blur-md shadow-md border-b border-white/5 transition-all duration-200";

const logoClass =
  "w-12 h-12 md:w-14 md:h-14 object-contain drop-shadow-lg transition-transform hover:scale-105 duration-300";
const navLinkClass =
  "font-serif tracking-wide text-sm md:text-base font-medium transition-all duration-300";
const navLinkActive = "text-primary-400";
const navLinkInactive = "text-zinc-400 hover:text-white";
---

<header class={headerClass} id="main-header">
  <div class="container mx-auto px-8">
    <div class="flex items-center justify-between py-4 md:py-5">
      <!-- Logo and Title -->
      <a href={`/${lang}/`} class="flex items-center gap-3 md:gap-4 group">
        <div class="relative">
          <div
            class="absolute inset-0 bg-primary-500/20 blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-700 rounded-full"
          >
          </div>
          <img
            src="/images/logo.svg"
            alt="Government of Nepal Emblem"
            class={logoClass}
          />
        </div>

        <div class="flex flex-col">
          <h1
            class="font-serif font-bold text-zinc-100 leading-tight tracking-wide text-lg md:text-xl lg:text-2xl group-hover:text-white transition-colors"
          >
            {t.home.hero.chaudandigadhi}
          </h1>
          <p
            class="font-serif text-xs md:text-sm text-zinc-500 tracking-wider group-hover:text-zinc-400 transition-colors"
          >
            {t.home.hero.municipality}
          </p>
        </div>
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center justify-between flex-1 ml-8">
        <!-- Left side: Home and Chapters -->
        <div class="flex items-center gap-6">
          <a
            href={`/${lang}/`}
            class={`${navLinkClass} ${!currentChapter && (Astro.url.pathname.endsWith(`/${lang}/`) || Astro.url.pathname === "/" || Astro.url.pathname === "") ? navLinkActive : navLinkInactive}`}
          >
            {t.nav.home}
          </a>

          <!-- Mega Menu for Chapters -->
          {
            !hideMegaMenu && (
              <MegaMenu lang={lang} currentChapter={currentChapter} />
            )
          }
        </div>

        <!-- Right side: Theme Toggle and Language Switcher -->
        <div class="flex items-center gap-3">
          <ThemeToggle />
          <LanguageSwitcher lang={lang} currentPath={Astro.url.pathname} />
        </div>
      </nav>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-button"
        class="md:hidden p-2 text-zinc-400 hover:text-white transition-colors relative z-50"
        aria-label="Toggle menu"
      >
        <Menu size={24} id="menu-icon" class="transition-all duration-300" />
        <X
          size={24}
          id="close-icon"
          class="absolute top-2 left-2 opacity-0 rotate-90 scale-75 transition-all duration-300"
        />
      </button>
    </div>
  </div>

  <!-- Mobile Menu Overlay -->
  <div
    id="mobile-menu"
    class="fixed top-0 left-0 right-0 bottom-0 bg-[#050505]/98 backdrop-blur-xl z-40 opacity-0 pointer-events-none transition-all duration-300 md:hidden overflow-y-auto"
    style="height: 100dvh; width: 100vw;"
  >
    <div class="min-h-screen flex flex-col pt-20">
      <nav class="flex-1 px-8 py-8 space-y-6">
        <!-- Home Link -->
        <a
          href={`/${lang}/`}
          class={`block text-lg font-serif ${!currentChapter && (Astro.url.pathname.endsWith(`/${lang}/`) || Astro.url.pathname === "/" || Astro.url.pathname === "") ? "text-primary-400" : "text-zinc-400"}`}
        >
          {t.nav.home}
        </a>

        <div class="w-full h-px bg-white/5"></div>

        <!-- Mobile Mega Menu (Accordion Style) -->
        {
          !hideMegaMenu && (
            <div class="space-y-4">
              <MobileMegaMenu lang={lang} currentChapter={currentChapter} />
            </div>
          )
        }

        <div class="w-full h-px bg-white/5"></div>

        <!-- Annexures Link -->
        <a
          href={`/${lang}/annexures`}
          class={`block text-base font-serif transition-colors ${
            Astro.url.pathname.includes("/annexures")
              ? "text-primary-400"
              : "text-zinc-500"
          }`}
        >
          {t.nav.annexures}
        </a>

        <!-- Theme Toggle -->
        <div class="pt-6">
          <div class="scale-110 origin-left">
            <ThemeToggle />
          </div>
        </div>

        <!-- Language Switcher -->
        <div class="pt-2">
          <div class="scale-110 origin-left">
            <LanguageSwitcher lang={lang} currentPath={Astro.url.pathname} />
          </div>
        </div>
      </nav>
    </div>
  </div>
</header>

<script>
  const mobileMenuButton = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");
  const header = document.getElementById("main-header");

  let isMenuOpen = false;

  mobileMenuButton?.addEventListener("click", () => {
    isMenuOpen = !isMenuOpen;

    if (isMenuOpen) {
      mobileMenu?.classList.remove("opacity-0", "pointer-events-none");
      mobileMenu?.classList.add("opacity-100", "pointer-events-auto");
      document.body.style.overflow = "hidden"; // Prevent scrolling

      // Icon toggle
      menuIcon?.classList.add("opacity-0", "-rotate-90", "scale-75");
      closeIcon?.classList.remove("opacity-0", "rotate-90", "scale-75");
    } else {
      mobileMenu?.classList.add("opacity-0", "pointer-events-none");
      mobileMenu?.classList.remove("opacity-100", "pointer-events-auto");
      document.body.style.overflow = ""; // Restore scrolling

      // Icon toggle
      menuIcon?.classList.remove("opacity-0", "-rotate-90", "scale-75");
      closeIcon?.classList.add("opacity-0", "rotate-90", "scale-75");
    }
  });

  // Close menu when clicking a link
  mobileMenu?.querySelectorAll("a").forEach((link) => {
    link.addEventListener("click", () => {
      isMenuOpen = false;
      mobileMenu?.classList.add("opacity-0", "pointer-events-none");
      mobileMenu?.classList.remove("opacity-100", "pointer-events-auto");
      document.body.style.overflow = "";
      menuIcon?.classList.remove("opacity-0", "-rotate-90", "scale-75");
      closeIcon?.classList.add("opacity-0", "rotate-90", "scale-75");
    });
  });

  // Optional: Add scroll effect for home page header transparency
  const isHomePage = window.location.pathname.endsWith("/"); // Simple check, might need robust logic if languages are strictly /ne/ or /en/
  if (header && header.classList.contains("absolute")) {
    window.addEventListener("scroll", () => {
      // Don't change background if menu is open
      if (header.classList.contains("menu-open") || isMenuOpen) {
        return;
      }

      if (window.scrollY > 50) {
        header.classList.remove("bg-transparent", "border-white/10");
        header.classList.add(
          "bg-[#050505]/90",
          "backdrop-blur-md",
          "shadow-md",
          "border-white/5",
        );
      } else {
        header.classList.add("bg-transparent", "border-white/10");
        header.classList.remove(
          "bg-[#050505]/90",
          "backdrop-blur-md",
          "shadow-md",
          "border-white/5",
        );
      }
    });
  }
</script>

<style>
  /* Custom scrollbar for dropdown */
  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Mobile Menu Overlay Styles */
  #mobile-menu {
    transition:
      opacity 0.3s ease-in-out,
      visibility 0.3s ease-in-out;
  }

  #mobile-menu.opacity-100 {
    opacity: 1;
    visibility: visible;
  }

  #mobile-menu.opacity-0 {
    opacity: 0;
    visibility: hidden;
  }
</style>
