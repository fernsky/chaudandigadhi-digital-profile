---

---

<div
    id="population-map-container"
    class="relative w-full h-[500px] md:h-[700px] flex items-center justify-center"
>
    <svg
        id="population-map"
        class="w-full h-full"
        style="background: transparent;"></svg>

    <!-- Tooltip -->
    <div
        id="map-tooltip"
        class="absolute pointer-events-none opacity-0 bg-slate-900/95 text-white px-4 py-3 rounded-xl border border-slate-700/50 backdrop-blur-xl text-sm transition-all duration-300 z-50 shadow-2xl"
    >
        <div
            class="font-bold text-lg mb-1 text-slate-100"
            data-label="ward-name"
        >
        </div>
        <div class="text-slate-400 text-sm" data-label="population"></div>
    </div>
</div>

<script>
    import {
        select,
        geoPath,
        geoMercator,
        scaleSequential,
        interpolateRgb,
        easeCubicOut,
    } from "d3";
    import { wardsGeoJSON } from "./wardsData";

    function initMap() {
        console.log("ðŸ—ºï¸ Initializing map...");

        const container = document.getElementById("population-map-container");
        const svg = select("#population-map");
        const tooltip = select("#map-tooltip");

        if (!container) {
            console.error("Container not found!");
            return;
        }

        const width = 900;
        const height = 700;

        // Clear existing content
        svg.selectAll("*").remove();

        // Set viewBox
        svg.attr("viewBox", `0 0 ${width} ${height}`).attr(
            "preserveAspectRatio",
            "xMidYMid meet",
        );

        // Manual projection configuration
        const centerLon = 86.88;
        const centerLat = 26.8;

        const projection = geoMercator()
            .center([centerLon, centerLat])
            .scale(180000) // Larger scale for bigger map
            .translate([width / 2, height / 2]);

        const pathGenerator = geoPath().projection(projection);

        // Main group with subtle 3D transform
        const g = svg
            .append("g")
            .attr("class", "map-layers")
            .attr("transform", "translate(0, 20) scale(1, 0.95)"); // Subtle 3D perspective

        // Premium color scale - from dark teal to vibrant cyan/blue
        const populations = wardsGeoJSON.features.map(
            (f) => f.properties.total_population,
        );
        const minPop = Math.min(...populations);
        const maxPop = Math.max(...populations);

        // Premium gradient: dark slate-teal to bright cyan-blue
        const colorScale = scaleSequential()
            .domain([minPop, maxPop])
            .interpolator(interpolateRgb("#1e3a5f", "#60a5fa")); // Dark blue to light blue

        // Function to clean the path by removing the bounding box
        function cleanPath(pathString: string | null): string {
            if (!pathString) return "";
            const firstZIndex = pathString.indexOf("Z");
            if (firstZIndex === -1) return pathString;
            return pathString.substring(0, firstZIndex + 1);
        }

        // 1. Draw Shadows (3D depth effect)
        const shadows = g
            .append("g")
            .attr("class", "shadow-layer")
            .selectAll("path")
            .data(wardsGeoJSON.features)
            .join("path")
            .attr("d", (d) => cleanPath(pathGenerator(d)))
            .attr("fill", "#0f172a") // Very dark blue-black
            .attr("opacity", 0.4)
            .attr("transform", "translate(6, 8)") // Shadow offset
            .style("filter", "blur(4px)");

        // 2. Main Ward Layers
        const wards = g
            .append("g")
            .attr("class", "wards-layer")
            .selectAll("path")
            .data(wardsGeoJSON.features)
            .join("path")
            .attr("d", (d) => cleanPath(pathGenerator(d)))
            .attr("fill", "none")
            .attr("stroke", "rgba(148, 163, 184, 0.3)") // Subtle slate stroke
            .attr("stroke-width", 1.5)
            .attr("class", "ward-path cursor-pointer")
            .style("pointer-events", "all")
            .attr("fill-opacity", 0);

        console.log("Ward paths created:", wards.size());

        // Animation Logic
        function runAnimation() {
            console.log("ðŸŽ¬ Running animation...");

            wards.each(function (d, i) {
                const node = this as SVGPathElement;
                const length = node.getTotalLength();

                select(node)
                    .attr("stroke-dasharray", length)
                    .attr("stroke-dashoffset", length)
                    .attr("stroke", "rgba(148, 163, 184, 0.5)")
                    .attr("stroke-width", 2)
                    .transition()
                    .duration(1800)
                    .delay(i * 150)
                    .ease(easeCubicOut)
                    .attr("stroke-dashoffset", 0)
                    .transition()
                    .delay(400)
                    .duration(1200)
                    .attr("fill", colorScale(d.properties.total_population))
                    .attr("fill-opacity", 0.65) // Premium transparency
                    .attr("stroke", "rgba(148, 163, 184, 0.4)")
                    .attr("stroke-width", 1.5);
            });
        }

        // Interactivity (Premium hover effects)
        wards
            .on("mouseenter", function (event, d) {
                const currentColor = colorScale(d.properties.total_population);

                select(this)
                    .transition()
                    .duration(250)
                    .attr("fill-opacity", 0.9)
                    .attr("stroke", "#60a5fa") // Bright blue highlight
                    .attr("stroke-width", 2.5)
                    .attr("filter", "brightness(1.2)");

                tooltip
                    .style("opacity", 1)
                    .select('[data-label="ward-name"]')
                    .text(d.properties.name_en || d.properties.name_ne);

                tooltip
                    .select('[data-label="population"]')
                    .text(
                        `Population: ${d.properties.total_population.toLocaleString()}`,
                    );
            })
            .on("mousemove", function (event) {
                const [x, y] = [event.pageX, event.pageY];
                tooltip
                    .style("left", x + 15 + "px")
                    .style("top", y - 15 + "px");
            })
            .on("mouseleave", function () {
                select(this)
                    .transition()
                    .duration(250)
                    .attr("fill-opacity", 0.65)
                    .attr("stroke", "rgba(148, 163, 184, 0.4)")
                    .attr("stroke-width", 1.5)
                    .attr("filter", "none");

                tooltip.style("opacity", 0);
            });

        // Scroll Trigger
        const observer = new IntersectionObserver(
            (entries) => {
                if (entries[0].isIntersecting) {
                    console.log("Map is visible, starting animation");
                    runAnimation();
                    observer.unobserve(container);
                }
            },
            { threshold: 0.3 },
        );

        observer.observe(container);

        console.log("âœ… Map initialization complete");
    }

    // Handle Astro Page Load/Transitions
    document.addEventListener("astro:page-load", () => {
        initMap();
    });

    // Initialize on first load
    if (document.readyState === "complete") {
        initMap();
    } else {
        window.addEventListener("load", initMap);
    }
</script>

<style>
    .ward-path {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Premium glow effect on hover */
    .ward-path:hover {
        filter: drop-shadow(0 0 8px rgba(96, 165, 250, 0.4));
    }
</style>
